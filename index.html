<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nh·∫≠t K√Ω L·ªõp 2A8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
/* Hi·ªáu ·ª©ng khung v√†ng l·∫•p l√°nh */
.frame-gold-sparkle {
    box-shadow: 0 0 10px #ffd700, inset 0 0 5px #fff;
    animation: gold-glow 2s infinite alternate;
}

/* Hi·ªáu ·ª©ng khung b·∫°c l·∫•p l√°nh */
.frame-silver-sparkle {
    box-shadow: 0 0 10px #c0c0c0, inset 0 0 5px #fff;
    animation: silver-glow 2s infinite alternate;
}

@keyframes gold-glow {
    0% { filter: brightness(1) drop-shadow(0 0 2px #ffd700); }
    100% { filter: brightness(1.5) drop-shadow(0 0 8px #fff700); }
}

@keyframes silver-glow {
    0% { filter: brightness(1) drop-shadow(0 0 2px #c0c0c0); }
    100% { filter: brightness(1.3) drop-shadow(0 0 8px #ffffff); }
}

/* Th√™m c√°c h·∫°t l·∫•p l√°nh nh·ªè (T√πy ch·ªçn) */
.frame-gold-sparkle::after {
    content: '‚ú®';
    position: absolute;
    font-size: 8px;
    top: -5px;
    right: -5px;
    animation: sparkle-move 1.5s infinite;
}

@keyframes sparkle-move {
    0%, 100% { opacity: 0; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.2); }
}
/* Hi·ªáu ·ª©ng qu·∫£ ƒëung ƒë∆∞a nh·∫π */
@keyframes sway {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
}
.animate-bounce-slow {
    animation: sway 3s infinite ease-in-out;
}
/* Hi·ªáu ·ª©ng hi·ªán modal */
@keyframes zoomIn {
    from { transform: scale(0); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.animate-zoom-in {
    animation: zoomIn 0.3s ease-out;
}
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; touch-action: manipulation; transition: background 0.5s ease; }
        
        /* === THEME GI√ÅNG SINH === */
        body.theme-xmas {
            background-image: url('https://cdn.mobilecity.vn/mobilecity-vn/images/2024/03/hinh-nen-powerpoint-tet-mau-do-truyen-thong.jpg');
            background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat;
        }
        @media only screen and (max-width: 600px) {
            body.theme-xmas {
                background-image: url('https://cdnv2.tgdd.vn/mwg-static/common/News/1066345/Hinh-nen-tet-2025-cho-dien-thoai-28.jpg');
                background-size: cover; background-position: center; background-attachment: fixed; 
            }
        }
        body.theme-xmas::after { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: -2; }
        body.theme-xmas .bg-white, body.theme-xmas .bg-white\/80, body.theme-xmas .bg-white\/90, body.theme-xmas .bg-gray-50, body.theme-xmas .bg-yellow-50, body.theme-xmas input, body.theme-xmas textarea { color: #1e293b !important; }
        body.theme-xmas #detail-view .text-slate-800, body.theme-xmas #detail-view svg { color: #1e293b !important; }
        body.theme-xmas #dashboard-view h2.text-slate-800 { color: #f1f5f9 !important; } 
        body.theme-xmas .notif-content { color: #1e293b !important; }
        .greeting-text { color: #4f46e5 !important; } 
        .falling-item { position: fixed; top: -10%; z-index: 9999; user-select: none; pointer-events: none; animation-name: fall-spin; animation-timing-function: linear; animation-iteration-count: infinite; }
        @keyframes fall-spin { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        body.theme-tet { background-color: #fff1f2; background-image: linear-gradient(to bottom, #fff1f2, #ffe4e6); }
        body.theme-tet::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 200px; background: radial-gradient(circle at top left, #fbcfe8 0%, transparent 40%), radial-gradient(circle at top right, #fecdd3 0%, transparent 40%); z-index: -1; pointer-events: none; }

        .view-section { display: none; width: 100%; height: 100vh; }
        .view-section.active-flex { display: flex; } 
        .view-section.active-block { display: block; height: auto; min-height: 100vh; } 
        
        /* --- ƒêO·∫†N CODE M·ªöI (HI·ªÜU ·ª®NG 3D CAO C·∫§P) --- */
.color-card { 
    position: relative; 
    overflow: hidden; 
    border-radius: 1.5rem; 
    padding: 1.5rem; 
    color: white; 
    cursor: pointer;
    
    /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
    
    /* T·∫°o kh·ªëi 3D tƒ©nh */
    box-shadow: 
        0 4px 6px rgba(0, 0, 0, 0.1),        /* B√≥ng g·∫ßn */
        0 10px 15px -3px rgba(0,0,0,0.1),    /* B√≥ng xa */
        inset 0 1px 0 rgba(255,255,255,0.4); /* Vi·ªÅn s√°ng tr√™n ƒë·ªânh (t·∫°o ƒë·ªô v√°t) */
    
    border-bottom: 4px solid rgba(0,0,0,0.1); /* Gi·∫£ l·∫≠p ƒë·ªô d√†y c·ªßa h·ªôp */
}

/* Khi di chu·ªôt v√†o (Bay l√™n) */
.color-card:hover {
    transform: translateY(-6px) scale(1.02); /* Nh·∫•c l√™n 6px v√† ph√≥ng to nh·∫π */
    box-shadow: 
        0 20px 25px -5px rgba(0, 0, 0, 0.2), /* B√≥ng ƒë·ªï s√¢u xu·ªëng s√†n */
        0 10px 10px -5px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.4);
    z-index: 10; /* N·ªïi l√™n tr√™n c√°c h·ªôp kh√°c */
}

/* Khi b·∫•m v√†o (L√∫n xu·ªëng) */
.color-card:active {
    transform: translateY(0) scale(0.98); /* Tr·ªü v·ªÅ v·ªã tr√≠ c≈© v√† nh·ªè l·∫°i */
    box-shadow: 
        0 2px 4px rgba(0,0,0,0.1), 
        inset 0 2px 4px rgba(0,0,0,0.1); /* B√≥ng l√∫n v√†o trong */
    border-bottom: 0px solid transparent; /* M·∫•t ƒë·ªô d√†y ƒë·∫ø */
}

/* (T√πy ch·ªçn) Hi·ªáu ·ª©ng cho icon b√™n trong xoay nh·∫π khi hover */
.color-card:hover .icon-box {
    transform: rotate(15deg) scale(1.1);
    transition: transform 0.3s ease;
    background: rgba(255,255,255,0.4); /* Icon s√°ng h∆°n */
}
        .icon-box { background: rgba(255,255,255,0.25); width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; backdrop-filter: blur(4px); }
        
        .bg-diary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .bg-pets { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .bg-chat { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-admin { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .bg-stars { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); }
        .bg-bday { background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%); }
        .bg-notif { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .bg-settings { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .bg-quiz { background: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%); }
        .bg-shop { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .bg-gratitude { background: linear-gradient(135deg, #4ade80 0%, #166534 100%); 
}
        /* M√ÄU CHO GAME NU√îI TH√ö */
        .bg-petgame { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }

        .banner-wrapper { width: 100%; border-radius: 1rem; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255,255,255,0.5); margin-bottom: 1.5rem; background-color: rgba(229, 231, 235, 0.5); }
        #main-banner { width: 100%; height: auto; display: block; }
        #banner-controls { position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10; }

        .honor-board { background: #fff; border: 4px solid #fcd34d; border-radius: 20px; padding: 20px; position: relative; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); background-image: radial-gradient(#fefce8 20%, transparent 20%), radial-gradient(#fefce8 20%, transparent 20%); background-color: #ffffff; background-position: 0 0, 10px 10px; background-size: 20px 20px; margin-bottom: 1.5rem; }
        .honor-header { text-align: center; font-size: 1.5rem; font-weight: 900; color: #d97706; text-transform: uppercase; margin-bottom: 1.5rem; text-shadow: 2px 2px 0px #fde68a; font-family: 'Segoe UI', sans-serif; }
        .honor-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; justify-items: center; }
        @media (max-width: 640px) { .honor-grid { grid-template-columns: repeat(2, 1fr); } }
        .honor-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .honor-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 8px; background-color: #e5e7eb; }
        .honor-item:nth-child(3n+1) .honor-avatar { border-color: #f87171; }
        .honor-item:nth-child(3n+2) .honor-avatar { border-color: #4ade80; }
        .honor-item:nth-child(3n+3) .honor-avatar { border-color: #60a5fa; }
        .honor-name { font-weight: bold; color: #4b5563; font-size: 0.9rem; background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 6px; }

        #quick-chat-box { width: 100%; height: 22rem; background: white; border-radius: 1.5rem; margin-bottom: 1.5rem; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.1); border: 2px solid #e0e7ff; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; background-color: #f8fafc; }
        .chat-row { display: flex; gap: 8px; align-items: flex-end; width: 100%; }
        .chat-row.mine { justify-content: flex-end; }
        .chat-row.theirs { justify-content: flex-start; }
        .chat-avatar {
    width: 36px; 
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    padding: 2px; 
    background: transparent; /* S·ª≠a 'white' th√†nh 'transparent' */
    flex-shrink: 0;
    box-sizing: border-box; 
}
        .chat-msg { font-size: 0.875rem; padding: 0.5rem 0.8rem; border-radius: 1rem; max-width: 85%; line-height: 1.4; word-wrap: break-word; overflow-wrap: anywhere; word-break: normal; white-space: pre-wrap; }
        .chat-msg.mine { background: #e0e7ff; color: #3730a3; border-bottom-right-radius: 0.2rem; }
        .chat-msg.theirs { background: #ffffff; color: #334155; border: 1px solid #e2e8f0; border-bottom-left-radius: 0.2rem; }
        #chat-input-area { padding: 0.35rem; background: white; border-top: 1px solid #f1f5f9; display: flex; align-items: center; gap: 0.5rem; }
        
        .student-select-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: white; }
        .student-select-item:hover { background-color: #f9fafb; }
        .student-select-item input:checked + img { border-color: #eab308; border-width: 2px; }
        .student-select-item input:checked ~ div { font-weight: bold; color: #d97706; }
        
        .notif-dropdown { position: absolute; top: 100%; right: 0; width: 300px; background: white; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); z-index: 100; display: none; overflow: hidden; border: 1px solid #e2e8f0; margin-top: 10px; }
        .notif-item { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; gap: 10px; align-items: center; }
        .notif-item:hover { background-color: #f8fafc; }
        .notif-badge-icon { background: #eff6ff; color: #3b82f6; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        .quiz-option { padding: 15px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #374151; position: relative; overflow: hidden; }
        .quiz-option:hover { border-color: #a855f7; background: #f3e8ff; }
        .quiz-option:active { transform: scale(0.98); }
        .quiz-option.selected { pointer-events: none; }
        .quiz-correct { background-color: #22c55e !important; color: white !important; border-color: #22c55e !important; animation: pop 0.3s ease; }
        .quiz-wrong { background-color: #ef4444 !important; color: white !important; border-color: #ef4444 !important; animation: shake 0.3s ease; }
        .timer-bar { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; margin-bottom: 20px; }
        .timer-fill { height: 100%; background: #22c55e; width: 100%; transition: width 1s linear; }

        /* === HI·ªÜU ·ª®NG KHUNG AVATAR L·∫§P L√ÅNH (M·ªöI) === */

/* ƒê·ªãnh nghƒ©a chuy·ªÉn ƒë·ªông ph√°t s√°ng */
@keyframes shine-gold {
    0% { box-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700; border-color: #ffd700; transform: scale(1); }
    50% { box-shadow: 0 0 15px #ffea00, 0 0 25px #ffea00; border-color: #ffeb3b; transform: scale(1.05); }
    100% { box-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700; border-color: #ffd700; transform: scale(1); }
}

@keyframes shine-silver {
    0% { box-shadow: 0 0 5px #c0c0c0, 0 0 10px #c0c0c0; border-color: #c0c0c0; transform: scale(1); }
    50% { box-shadow: 0 0 15px #e0e0e0, 0 0 25px #ffffff; border-color: #ffffff; transform: scale(1.05); }
    100% { box-shadow: 0 0 5px #c0c0c0, 0 0 10px #c0c0c0; border-color: #c0c0c0; transform: scale(1); }
}

/* √Åp d·ª•ng cho Khung V√†ng */
.frame-gold {
    border: 3px solid #ffd700 !important;
    animation: shine-gold 2s infinite ease-in-out !important; /* L·∫∑p v√¥ t·∫≠n m·ªói 2 gi√¢y */
    transition: all 0.3s ease;
    z-index: 10; /* ƒê·∫£m b·∫£o n·ªïi l√™n tr√™n */
    position: relative;
    background-color: #fff; /* N·ªÅn tr·∫Øng ƒë·ªÉ ·∫£nh kh√¥ng b·ªã ch√¨m */
}

/* √Åp d·ª•ng cho Khung B·∫°c */
.frame-silver {
    border: 3px solid #c0c0c0 !important;
    animation: shine-silver 2s infinite ease-in-out !important;
    transition: all 0.3s ease;
    z-index: 10;
    position: relative;
    background-color: #fff;
}
        .shop-item { border: 1px solid #e5e7eb; border-radius: 1rem; padding: 1rem; background: white; text-align: center; transition: all 0.2s; }
        .shop-item:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .shop-btn { width: 100%; padding: 0.5rem; border-radius: 0.5rem; font-weight: bold; margin-top: 0.5rem; font-size: 0.875rem; transition: all 0.2s; }
        .btn-buy { background-color: #10b981; color: white; }
        .btn-buy:hover { background-color: #059669; }
        .btn-equip { background-color: #3b82f6; color: white; }
        .btn-equipped { background-color: #9ca3af; color: white; cursor: default; }

        #online-users-container { font-size: 0.75rem; color: #16a34a; font-weight: 600; margin-top: 0.25rem; display: flex; align-items: center; gap: 0.5rem; opacity: 0.9; }
        .online-dot { width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }

        /* --- STYLES M·ªöI CHO NU√îI TH√ö T·ª™ FILE INDEX1 --- */
        .pet-stage { 
            background-size: cover; background-repeat: no-repeat; background-position: center bottom;
            height: 320px; border-radius: 1rem; position: relative; overflow: hidden; margin-bottom: 1rem; border: 4px solid #d8b4fe;
            transition: background 0.5s;
        }
        .bg-pet-cat { background-image: url('https://img.freepik.com/free-vector/cartoon-living-room-interior-with-window-sofa_107791-2856.jpg'); }
        .bg-pet-dog { background-image: url('https://img.freepik.com/free-vector/cartoon-house-backyard-with-green-grass_107791-801.jpg'); }
        .bg-pet-bunny { background-image: url('https://img.freepik.com/free-vector/cartoon-forest-scene-with-trees-bushes_107791-286.jpg'); }

        .pet-character { 
            width: 140px; height: 140px; 
            background-size: contain; background-repeat: no-repeat; background-position: center bottom;
            position: absolute; bottom: 30px; left: 50%; 
            transition: left 2s ease-in-out, bottom 2s ease-in-out, transform 0.3s;
            cursor: pointer; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); z-index: 10;
        }
        
        .pet-accessory { position: absolute; top: -30px; left: 0; width: 100%; height: 70px; background-size: contain; background-repeat: no-repeat; background-position: center; pointer-events: none; z-index: 11; }
        .pet-dead { filter: grayscale(100%) blur(2px); opacity: 0.6; transform: rotate(90deg) !important; bottom: 10px !important; animation: none !important; }

        .pet-select-card { border: 2px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; background: #fff; overflow: hidden; }
        .pet-select-card.selected { border-color: #a855f7; background-color: #f3e8ff; transform: scale(1.05); }
        .pet-select-img { width: 80px; height: 80px; object-fit: contain; margin: 0 auto; display: block; }
        
        .pet-action-card { border-radius: 12px; padding: 10px; text-align: center; border: 2px solid; transition: all 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80px; background: white; }
        .pet-action-card:active { transform: scale(0.95); }
        .btn-feed { border-color: #fdba74; color: #ea580c; background-color: #fff7ed; }
        .btn-play { border-color: #f9a8d4; color: #db2777; background-color: #fdf2f8; }
        .btn-clean { border-color: #93c5fd; color: #2563eb; background-color: #eff6ff; }

        /* Animation */
        .pet-eating { animation: eat 0.6s infinite; }
        @keyframes eat { 0% { transform: scale(1); } 50% { transform: scale(1.1) rotate(5deg); } 100% { transform: scale(1); } }
        .pet-happy { animation: jump 0.6s infinite; }
        @keyframes jump { 0%, 100% { bottom: 30px; } 50% { bottom: 70px; } }
        .pet-shower { animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); } }

        .pet-stat-bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin-top: 2px; }
        .pet-stat-fill { height: 100%; transition: width 0.5s ease-out; }

        .hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
		/* Th√™m v√†o cu·ªëi kh·ªëi <style> */

/* ƒê·ªãnh nghƒ©a hi·ªáu ·ª©ng l·∫Øc l∆∞ */
@keyframes pet-wobble {
    0%, 100% {
        transform: scale(1.5) translateX(0); /* V·ªã tr√≠ gi·ªØa, ph√≥ng to 1.5 l·∫ßn */
    }
    15% {
        transform: scale(1.5) translateX(-5%); /* L·∫Øc sang tr√°i */
    }
    30% {
        transform: scale(1.5) translateX(5%); /* L·∫Øc sang ph·∫£i */
    }
    45% {
        transform: scale(1.5) translateX(-4%);
    }
    60% {
        transform: scale(1.5) translateX(4%);
    }
    75% {
        transform: scale(1.5) translateX(-2%);
    }
    90% {
        transform: scale(1.5) translateX(2%);
    }
}

/* Class √°p d·ª•ng hi·ªáu ·ª©ng v√† ƒë∆∞a th√∫ c∆∞ng ra ch√≠nh gi·ªØa */
.pet-zoom-wobble {
    /* ƒê∆∞a element ra gi·ªØa m√†n h√¨nh (fixed position) */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1.5); /* ƒê∆∞a v·ªÅ t√¢m v√† ph√≥ng to ban ƒë·∫ßu */
    
    /* √Åp d·ª•ng hi·ªáu ·ª©ng l·∫Øc l∆∞ trong 3 gi√¢y */
    animation: pet-wobble 3s ease-in-out forwards;
    
    /* ƒê·∫£m b·∫£o th√∫ ·∫£o n·ªïi l√™n tr√™n c√πng (v√≠ d·ª•: c√°c modal) */
    z-index: 1000; 
    
    /* Th√™m shadow ƒë·ªÉ th√∫ ·∫£o n·ªïi b·∫≠t */
    filter: drop-shadow(0 25px 25px rgba(0, 0, 0, 0.5));
    
    /* ƒê·∫£m b·∫£o chuy·ªÉn ƒë·ªông tr·ªü l·∫°i v·ªã tr√≠ c≈© m∆∞·ª£t m√† */
    transition: all 0.3s ease-in-out; 
    cursor: default; /* Kh√¥ng cho click trong khi ƒëang animation */
}
/* === TH√äM CSS CHO NH·∫¨T K√ù C√Å NH√ÇN === */
.bg-private { background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%); } /* M√†u t√≠m m·ªông m∆° */

/* Giao di·ªán t·ªù gi·∫•y nh·∫≠t k√Ω */
.private-note {
    background-color: #fffbeb; /* M√†u gi·∫•y v√†ng nh·∫°t */
    background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
    background-size: 100% 1.5rem; /* D√≤ng k·∫ª */
    border-left: 6px solid #f59e0b; /* L·ªÅ tr√°i m√†u cam */
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 2px 4px 6px rgba(0,0,0,0.1);
    position: relative;
    font-family: 'Courier New', Courier, monospace; /* Ph√¥ng ch·ªØ ki·ªÉu m√°y ƒë√°nh ch·ªØ cho ho√†i ni·ªám */
    line-height: 1.5rem;
}

.private-note::before {
    content: "üìå";
    position: absolute;
    top: -10px;
    right: 10px;
    font-size: 1.5rem;
    transform: rotate(15deg);
}

.private-date {
    display: inline-block;
    background: #f59e0b;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    font-family: 'Segoe UI', sans-serif; /* Quay v·ªÅ ph√¥ng th∆∞·ªùng cho ng√†y th√°ng d·ªÖ ƒë·ªçc */
}
    </style>
</head>
<body class="text-slate-800">

    <div id="login-view" class="view-section active-flex items-center justify-center bg-indigo-50/90 backdrop-blur-sm p-4 fixed inset-0 z-50">
        <div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-2xl text-center border-4 border-white">
            <img id="login-banner-img" src="https://via.placeholder.com/600x300?text=Lop+2A8" class="w-full h-auto rounded-2xl mb-5 shadow-sm border border-indigo-50" alt="Banner L·ªõp H·ªçc">
            <h1 class="text-2xl font-extrabold text-indigo-900 mb-2">L·ªõp 2A8</h1>
            <p class="text-gray-500 mb-6 text-sm">Nh·∫≠t k√Ω & K·∫øt n·ªëi y√™u th∆∞∆°ng</p>
            <div id="config-warning" class="hidden p-3 mb-4 bg-red-100 text-red-700 text-xs rounded-lg border border-red-300 text-left"><b>C·∫¢NH B√ÅO:</b> Ch∆∞a c·∫•u h√¨nh API Key.</div>
            <div class="space-y-3">
                <input id="username" class="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 ring-indigo-200 outline-none font-semibold text-gray-700" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                <input id="password" type="password" class="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 ring-indigo-200 outline-none font-semibold text-gray-700" placeholder="M·∫≠t kh·∫©u">
                <p id="login-error" class="text-red-500 text-sm font-bold hidden"></p>
                <button onclick="app.login()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition active:scale-95 flex justify-center items-center gap-2"><span>V√†o L·ªõp H·ªçc</span><i data-lucide="arrow-right" width="20"></i></button>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="view-section bg-transparent pb-20"> 
        <div class="bg-white/90 backdrop-blur-md sticky top-0 z-50 px-5 py-3 flex justify-between items-center shadow-sm rounded-b-xl mx-2 mt-2">
            <div class="font-black text-xl text-indigo-700 flex items-center gap-2 cursor-pointer" onclick="app.goHome()"><i data-lucide="school"></i> Nh√¢Ã£t kyÃÅ l∆°ÃÅp 2A8</div>
            <div class="flex items-center gap-3 relative">
                <span id="seasonal-greeting" class="text-xs font-bold text-red-500 hidden md:block"></span>
                <div class="relative cursor-pointer" onclick="app.toggleNotif()">
                    <div class="p-2 bg-indigo-50 rounded-full hover:bg-indigo-100 transition text-indigo-600">
                        <i data-lucide="bell" width="20"></i>
                    </div>
                    <span id="dash-notif-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white">0</span>
                    <div id="dash-notif-list" class="notif-dropdown">
                        <div class="p-3 text-sm font-bold text-gray-500 text-center">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
                    </div>
                </div>
                <button onclick="app.logout()" class="bg-red-50 text-red-500 px-3 py-2 rounded-lg font-bold text-xs flex items-center gap-1 hover:bg-red-100 transition">Tho√°t <i data-lucide="log-out" width="14"></i></button>
            </div>
        </div>

        <div class="max-w-4xl mx-auto p-5">
            <div class="banner-wrapper relative">
                <img id="main-banner" src="" class="hidden" alt="Banner L·ªõp 2A8">
                <div id="banner-controls" class="hidden">
                    <label class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-full cursor-pointer shadow-md transition inline-flex"><i data-lucide="camera" width="18"></i><input type="file" id="banner-file-input" onchange="window.app.uploadBanner()" class="hidden" accept="image/*"></label>
                </div>
                <div id="banner-placeholder" class="h-40 bg-gray-200 flex items-center justify-center text-gray-500 text-sm hidden">Ch∆∞a c√≥ banner.</div>
            </div>

            <div class="mb-6 flex flex-wrap items-center gap-2">
    <h2 class="h-9 flex items-center text-sm md:text-lg font-bold bg-white/80 px-3 rounded-xl backdrop-blur-sm shadow-sm greeting-text">
        Ch√†o, <span id="user-name" class="greeting-text ml-1">...</span>! <span id="wave-icon" class="ml-1">üëã</span>
    </h2>
    
    <button id="btn-checkin" onclick="window.app.dailyCheckIn()" class="h-9 bg-gradient-to-r from-emerald-400 to-green-600 text-white px-3 rounded-lg font-bold shadow-md hover:scale-105 transition flex items-center gap-1 text-xs animate-pulse">
        <i data-lucide="calendar-check" width="14"></i> <span>ƒêi·ªÉm Danh</span>
    </button>

    <div id="online-users-container" class="hidden w-full mt-1">
        <span class="online-dot"></span> <span id="online-users-list">ƒêang t·∫£i...</span>
    </div>
</div>

            <div id="quick-chat-box">
                <div class="px-4 py-2 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-indigo-800 flex items-center gap-2"><i data-lucide="messages-square" width="16"></i> Tr√≤ chuy·ªán l·ªõp h·ªçc</h3>
                    <button id="btn-clear-chat" onclick="window.app.clearChat()" class="text-red-500 hover:bg-red-100 p-1 rounded hidden" title="X√≥a to√†n b·ªô chat"><i data-lucide="trash-2" width="14"></i></button>
                </div>
                <div id="chat-messages">
                    <div class="text-center text-gray-400 text-xs mt-2">B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán...</div>
                </div>
                <div id="chat-input-area">
                    <div class="flex gap-1 overflow-x-auto no-scrollbar max-w-[120px]">
                        <span onclick="window.app.addEmojiToChat('üòä')" class="cursor-pointer hover:bg-gray-100 p-1 rounded text-lg">üòä</span>
                        <span onclick="window.app.addEmojiToChat('üòÇ')" class="cursor-pointer hover:bg-gray-100 p-1 rounded text-lg">üòÇ</span>
                        <span onclick="window.app.addEmojiToChat('‚ù§Ô∏è')" class="cursor-pointer hover:bg-gray-100 p-1 rounded text-lg">‚ù§Ô∏è</span>
                        <span onclick="window.app.addEmojiToChat('üëç')" class="cursor-pointer hover:bg-gray-100 p-1 rounded text-lg">üëç</span>
                    </div>
                    <input id="chat-input" class="flex-1 border-none bg-gray-100 rounded-full px-3 py-2 text-sm focus:ring-2 ring-indigo-200 outline-none" placeholder="Nh·∫Øn tin...">
                    <button onclick="window.app.sendChat()" class="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition"><i data-lucide="send" width="16"></i></button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <div onclick="app.nav('diary')" class="color-card bg-diary"><div class="icon-box"><i data-lucide="book-open"></i></div><h3 class="text-lg font-bold">Nh·∫≠t K√Ω H√†ng Ng√†y</h3><p class="text-xs opacity-90">Nh·ªØng vi·ªác t·ªët v√† ni·ªÅm vui.</p></div>


<div onclick="app.nav('private')" class="color-card bg-private">
    <div class="icon-box"><i data-lucide="lock"></i></div>
    <h3 class="text-lg font-bold">Nh·∫≠t K√Ω C√° Nh√¢n</h3>
    <p class="text-xs opacity-90">G√≥c ri√™ng t∆∞ c·ªßa con.</p>
</div>
                <div onclick="app.nav('pets')" class="color-card bg-pets"><div class="icon-box"><i data-lucide="cat"></i></div><h3 class="text-lg font-bold">G√≥c Th√∫ C∆∞ng</h3><p class="text-xs opacity-90">Khoe nh∆∞ÃÉng con v√¢Ã£t nu√¥i cuÃâa baÃ£n.</p></div>
                <div onclick="app.nav('chat')" class="color-card bg-chat"><div class="icon-box"><i data-lucide="message-circle"></i></div><h3 class="text-lg font-bold">H·ªèi ƒê√°p B√†i T·∫≠p</h3><p class="text-xs opacity-90">Trao ƒë·ªïi b√†i t·∫≠p c√πng c√¥ vaÃÄ b·∫°n.</p></div>
                <div onclick="app.nav('notif')" class="color-card bg-notif"><div class="icon-box"><i data-lucide="bell"></i></div><h3 class="text-lg font-bold">Th√¥ng B√°o</h3><p class="text-xs opacity-90">Tin t·ª©c t·ª´ c√¥ gi√°o.</p></div>
<div onclick="window.app.openGratitudeTree()" class="color-card bg-gratitude">
    <div class="icon-box">
        <span class="text-2xl">üå≥</span> 
    </div>
    
    <h3 class="text-lg font-bold">C√¢y Bi·∫øt ∆†n</h3>
    
    <p class="text-xs opacity-90">Gieo h·∫°t m·∫ßm y√™u th∆∞∆°ng.</p>
</div>

                <div onclick="app.nav('stars')" class="color-card bg-stars"><div class="icon-box"><i data-lucide="star"></i></div><h3 class="text-lg font-bold">H·ªçc Sinh Ngoan</h3><p class="text-xs opacity-90">Vinh danh hoÃ£c sinh ngoan haÃÄng tu√¢ÃÄn.</p></div>
                <div onclick="app.nav('bday')" class="color-card bg-bday"><div class="icon-box"><i data-lucide="gift"></i></div><h3 class="text-lg font-bold">G√≥c Sinh Nh·∫≠t</h3><p class="text-xs opacity-90">Ch√∫c m·ª´ng sinh nh·∫≠t!</p></div>
                <div onclick="app.nav('quiz')" class="color-card bg-quiz"><div class="icon-box"><i data-lucide="brain-circuit"></i></div><h3 class="text-lg font-bold">Thi Tr·∫Øc Nghi·ªám Online</h3><p class="text-xs opacity-90">Th·ª≠ t√†i ki·∫øn th·ª©c online.</p></div>
                <div onclick="app.nav('shop')" class="color-card bg-shop"><div class="icon-box"><i data-lucide="shopping-bag"></i></div><h3 class="text-lg font-bold">G√≥c ƒê·ªïi Qu√†</h3><p class="text-xs opacity-90">D√πng Xu ƒë·ªïi khung Avatar.</p></div>
                <div onclick="app.nav('petgame')" class="color-card bg-petgame"><div class="icon-box"><i data-lucide="paw-print"></i></div><h3 class="text-lg font-bold">Nu√¥i Th√∫ ·∫¢o</h3><p class="text-xs opacity-90">ChƒÉm s√≥c ng∆∞·ªùi b·∫°n nh·ªè.</p></div>
                
                <div onclick="app.nav('settings')" class="color-card bg-settings"><div class="icon-box"><i data-lucide="user-cog"></i></div><h3 class="text-lg font-bold">C√†i ƒê·∫∑t</h3><p class="text-xs opacity-90">ƒê·ªïi m·∫≠t kh·∫©u, Avatar.</p></div>
                <div id="admin-card" onclick="app.nav('admin')" class="color-card bg-admin hidden"><div class="icon-box"><i data-lucide="settings"></i></div><h3 class="text-lg font-bold">Qu·∫£n L√Ω L·ªõp</h3><p class="text-xs opacity-90">D√†nh ri√™ng cho Admin.</p></div>
            </div>
        </div>
    </div>

    <div id="detail-view" class="view-section bg-transparent pb-20">
        <div class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur z-50 border-b px-4 py-3 flex items-center justify-between shadow-sm transition-transform">
            <div class="flex items-center gap-3">
                <button onclick="app.goHome()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><i data-lucide="arrow-left"></i></button>
                <h2 id="page-title" class="font-bold text-lg text-slate-800 truncate">...</h2>
            </div>
            
            <div id="user-balance-display" class="hidden bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 border border-yellow-300">
                <i data-lucide="coins" width="14"></i> <span id="current-coins">0</span> Xu
            </div>

            <div class="relative cursor-pointer" onclick="app.toggleNotif('detail')">
                <div class="p-2 bg-indigo-50 rounded-full hover:bg-indigo-100 transition text-indigo-600">
                    <i data-lucide="bell" width="20"></i>
                </div>
                <span id="detail-notif-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white">0</span>
                <div id="detail-notif-list" class="notif-dropdown" style="right: 0;">
                    <div class="p-3 text-sm font-bold text-gray-500 text-center">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
                </div>
            </div>
        </div>

        <div class="max-w-2xl mx-auto p-4 pt-20">
            <div id="petgame-container" class="hidden">
                <div id="pet-select-screen" class="hidden bg-white p-6 rounded-2xl shadow-lg text-center">
                    <h3 class="text-xl font-bold text-purple-700 mb-4">Ch·ªçn Ng∆∞·ªùi B·∫°n ƒê·ªìng H√†nh</h3>
                    <input id="pet-name-input" class="w-full p-3 mb-4 border rounded-xl font-bold text-center" placeholder="ƒê·∫∑t t√™n cho th√∫ c∆∞ng...">
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div onclick="app.selectPetType('dog')" class="pet-select-card p-3 rounded-xl bg-gray-50 border border-gray-200" id="sel-dog">
                            <img src="https://i.pinimg.com/originals/1a/ad/ea/1aadea234ad1b805c2d39cd892abdfad.gif" class="pet-select-img">
                            <div class="font-bold text-sm mt-2">C√∫n Con</div>
                            <div class="text-xs text-orange-500 font-bold">100 Xu</div>
                        </div>
                        <div onclick="app.selectPetType('cat')" class="pet-select-card p-3 rounded-xl bg-gray-50 border border-gray-200" id="sel-cat">
                            <img src="https://i.pinimg.com/originals/9e/6d/c0/9e6dc0a2a7f7924dd040854a7fbcb988.gif" class="pet-select-img">
                            <div class="font-bold text-sm mt-2">M√®o Con</div>
                             <div class="text-xs text-orange-500 font-bold">150 Xu</div>
                        </div>
                        <div onclick="app.selectPetType('bunny')" class="pet-select-card p-3 rounded-xl bg-gray-50 border border-gray-200" id="sel-bunny">
                            <img src="https://i.pinimg.com/originals/3a/0e/11/3a0e1105df06e7a3a24d0229920fb1d3.gif" class="pet-select-img">
                            <div class="font-bold text-sm mt-2">Th·ªè Con</div>
                             <div class="text-xs text-orange-500 font-bold">200 Xu</div>
                        </div>
                    </div>
                    <button onclick="app.confirmPetSelection()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition">Nh·∫≠n Nu√¥i Ngay</button>
                </div>

              <div id="pet-main-screen" class="hidden">
                    <div id="pet-stage-bg" class="pet-stage shadow-lg border-4 border-purple-200 relative bg-white transition-all">
                        
                        <div id="pet-decor-layer"></div>
                        <div id="pet-display" class="pet-character pet-move" onclick="window.app.animatePetClick()"></div>
                        <div id="pet-waste-container" class="absolute inset-0 pointer-events-none" style="z-index: 100;"></div>
                        <audio id="pet-audio" loop class="hidden"></audio>
                        
                        <div id="pet-chat-bubble" class="hidden absolute top-4 left-1/2 -translate-x-1/2 bg-white px-4 py-2 rounded-2xl shadow-lg border-2 border-purple-300 max-w-[200px] text-center z-30 animate-bounce-slow">
                            <p id="pet-chat-text" class="text-sm font-bold text-purple-700">...</p>
                            <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-b-2 border-r-2 border-purple-300 rotate-45"></div>
                        </div>

                        <div class="absolute bottom-4 left-4 right-4 flex gap-2 z-40">
                            <input id="pet-input-text" class="flex-1 bg-white/90 border-2 border-purple-300 rounded-full px-4 py-2 text-sm font-bold shadow-lg outline-none text-purple-900" placeholder="N√≥i ho·∫∑c vi·∫øt g√¨ ƒë√≥...">
                            
                            <button onclick="window.app.sendPetText()" class="bg-blue-500 text-white p-2 rounded-full shadow border-2 border-white hover:bg-blue-600 transition">
                                <i data-lucide="send" width="20"></i>
                            </button>
                            <button onclick="window.app.startListening()" id="btn-mic" class="bg-purple-500 text-white p-2 rounded-full shadow border-2 border-white hover:bg-purple-600 transition animate-pulse">
                                <i data-lucide="mic" width="20"></i>
                            </button>
                        </div>

                        <div id="pet-dead-overlay" class="absolute inset-0 bg-black/80 flex items-center justify-center text-white font-bold hidden flex-col z-20 text-center p-4">
                            <div class="text-6xl mb-4">üëª</div>
                            <div class="text-xl text-center px-4">Th√∫ c∆∞ng ƒë√£ m·∫•t v√¨ ƒë√≥i!</div>
                            <button onclick="app.revivePet()" class="mt-6 bg-green-500 px-6 py-3 rounded-xl font-bold text-white shadow-lg border-2 border-green-400">‚ö° H·ªìi sinh (300 Xu)</button>
                            <button onclick="app.resetPet()" class="mt-2 text-sm text-gray-300 underline hover:text-white">Nu√¥i con m·ªõi</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-purple-100 mb-4">
                        ```



                        <div id="pet-status-bubble" class="absolute top-4 right-4 bg-white px-3 py-1 rounded-full text-xs font-bold shadow text-purple-600 hidden z-10 animate-bounce">Vui v·∫ª!</div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-purple-100 mb-4">
                        <div class="flex justify-between items-end mb-3">
                            <div>
                                <h3 id="pet-name-display" class="font-bold text-lg text-slate-800">Th√∫ C∆∞ng</h3>
                                <div class="text-xs text-gray-500">EXP: <span id="pet-exp">0</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500">C·∫•p ƒë·ªô</div>
                                <div id="pet-level" class="font-bold text-2xl text-purple-600">1</div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="pet-stat-bar-bg"><div id="bar-hunger" class="pet-stat-fill bg-orange-400" style="width: 100%"></div></div>
                            <div class="flex justify-between text-xs font-bold mb-1"><span class="text-orange-500">ƒê·ªô No</span> <span id="val-hunger" class="text-slate-600">100%</span></div>
                            
                            <div class="pet-stat-bar-bg"><div id="bar-fun" class="pet-stat-fill bg-pink-400" style="width: 100%"></div></div>
                            <div class="flex justify-between text-xs font-bold mb-1"><span class="text-pink-500">Vui V·∫ª</span> <span id="val-fun" class="text-slate-600">100%</span></div>
                            
                            <div class="pet-stat-bar-bg"><div id="bar-hygiene" class="pet-stat-fill bg-blue-400" style="width: 100%"></div></div>
                            <div class="flex justify-between text-xs font-bold mb-1"><span class="text-blue-500">S·∫°ch S·∫Ω</span> <span id="val-hygiene" class="text-slate-600">100%</span></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div onclick="app.toggleFoodMenu()" class="pet-action-card btn-feed">
                            <i data-lucide="utensils" width="24" class="mb-1"></i>
                            <div class="font-bold text-xs mt-1">Cho ƒÇn</div>
                        </div>
                        <div onclick="app.playPet()" class="pet-action-card btn-play">
                            <i data-lucide="gamepad-2" width="24" class="mb-1"></i>
                            <div class="font-bold text-xs mt-1">Ch∆°i ƒê√πa</div>
                        </div>
                        <div onclick="app.cleanPet()" class="pet-action-card btn-clean">
                            <i data-lucide="droplets" width="24" class="mb-1"></i>
                            <div class="font-bold text-xs mt-1">T·∫Øm R·ª≠a</div>
                        </div>
                    </div>

                    <div id="pet-food-menu" class="hidden bg-orange-50 p-4 rounded-xl border border-orange-200 mb-4 animate-fade-in">
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-orange-800 text-sm">Ch·ªçn Th·ª©c ƒÇn</h4><button onclick="document.getElementById('pet-food-menu').classList.add('hidden')" class="text-orange-500 font-bold">X</button></div>
                        <div class="grid grid-cols-3 gap-2">
    <button onclick="window.app.buyPetItem(10, 'hunger', 100)" class="bg-white p-2 rounded-lg border border-orange-100 shadow-sm text-center hover:bg-orange-100">
        <div class="text-2xl">üç∞</div><div class="text-xs font-bold mt-1">B√°nh</div><div class="text-[10px] text-gray-500">10 Xu</div>
    </button>
    
    <button onclick="window.app.buyPetItem(5, 'hunger', 50)" class="bg-white p-2 rounded-lg border border-orange-100 shadow-sm text-center hover:bg-orange-100">
        <div class="text-2xl">üç¶</div><div class="text-xs font-bold mt-1">Kem</div><div class="text-[10px] text-gray-500">5 Xu</div>
    </button>
    
    <button onclick="window.app.buyPetItem(3, 'hunger', 25)" class="bg-white p-2 rounded-lg border border-orange-100 shadow-sm text-center hover:bg-orange-100">
        <div class="text-2xl">üç¨</div><div class="text-xs font-bold mt-1">K·∫πo</div><div class="text-[10px] text-gray-500">3 Xu</div>
    </button>
</div>
                    </div>
                    
                    <button onclick="app.togglePetAccessories()" class="w-full py-3 bg-purple-100 text-purple-700 font-bold rounded-xl hover:bg-purple-200 transition border border-purple-300 flex items-center justify-center gap-2">
                        <i data-lucide="shirt" width="18"></i> C·ª≠a H√†ng Ph·ª• Ki·ªán - Ch∆∞a M·ªü
                    </button>
                    
                    <div id="pet-accessories-panel" class="hidden fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-3xl shadow-2xl border-t-4 border-purple-200 z-50 m-0">
                        <div class="flex justify-between mb-4">
                            <h4 class="font-bold text-lg text-purple-800">Ph·ª• Ki·ªán Th·ªùi Trang (50 Xu)</h4>
                            <button onclick="document.getElementById('pet-accessories-panel').classList.add('hidden')" class="bg-gray-200 p-2 rounded-full text-gray-600"><i data-lucide="x" width="16"></i></button>
                        </div>
                        <div class="grid grid-cols-4 gap-3">
                            <div onclick="app.buyAccessory('hat')" class="cursor-pointer p-3 border-2 border-gray-100 rounded-xl text-center hover:border-purple-300 hover:bg-purple-50 transition"><div class="text-3xl">üé©</div><div class="text-xs mt-1 font-bold">M≈©</div></div>
                            <div onclick="app.buyAccessory('bow')" class="cursor-pointer p-3 border-2 border-gray-100 rounded-xl text-center hover:border-purple-300 hover:bg-purple-50 transition"><div class="text-3xl">üéÄ</div><div class="text-xs mt-1 font-bold">N∆°</div></div>
                            <div onclick="app.buyAccessory('glasses')" class="cursor-pointer p-3 border-2 border-gray-100 rounded-xl text-center hover:border-purple-300 hover:bg-purple-50 transition"><div class="text-3xl">üëì</div><div class="text-xs mt-1 font-bold">K√≠nh</div></div>
                            <div onclick="app.buyAccessory('scarf')" class="cursor-pointer p-3 border-2 border-gray-100 rounded-xl text-center hover:border-purple-300 hover:bg-purple-50 transition"><div class="text-3xl">üß£</div><div class="text-xs mt-1 font-bold">KhƒÉn</div></div>
                        </div>
                    </div>

                </div>
            </div>
            <div id="quiz-container" class="hidden">
                <div id="quiz-waiting" class="bg-white p-8 rounded-3xl shadow-lg text-center border-4 border-purple-200 hidden">
                    <div class="text-6xl mb-4 animate-bounce">‚è≥</div>
                    <h2 class="text-xl font-bold text-purple-700 mb-2">ƒêANG CH·ªú C√î GI√ÅO...</h2>
                    <p class="text-gray-500">Cu·ªôc thi s·∫Ω b·∫Øt ƒë·∫ßu khi c√¥ gi√°o th√¥ng b√°o.</p>
                </div>
                <div id="quiz-playing" class="hidden">
                    <div class="bg-white p-5 rounded-2xl shadow-lg border border-purple-100 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-gray-400">C√ÇU <span id="q-idx"></span>/<span id="q-total"></span></span>
                            <span class="text-lg font-black text-purple-600" id="q-score-disp">0 ƒëi·ªÉm</span>
                        </div>
                        <div class="timer-bar"><div id="timer-bar-fill" class="timer-fill"></div></div>
                        <div id="q-text" class="text-lg font-bold text-slate-800 mb-4"></div>
                        <div id="q-options" class="grid grid-cols-1 gap-3"></div>
                        <button id="btn-next-q" onclick="app.nextQuestion()" class="w-full mt-4 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 hidden">C√¢u Ti·∫øp Theo <i data-lucide="arrow-right" class="inline w-4 h-4"></i></button>
                    </div>
                </div>
                <div id="quiz-result" class="bg-white p-8 rounded-3xl shadow-lg text-center border-4 border-yellow-300 hidden">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <h2 class="text-xl font-black text-yellow-600 mb-2">CH√öC M·ª™NG HO√ÄN TH√ÄNH!</h2>
                    <p class="text-gray-600">ƒêi·ªÉm s·ªë c·ªßa b·∫°n:</p>
                    <div id="final-score" class="text-5xl font-black text-purple-700 mb-6">0</div>
                    <p class="text-sm text-green-600 font-bold bg-green-100 p-2 rounded inline-block mb-4">+ <span id="earned-coins">0</span> Xu v√†o v√≠!</p>
                    <div id="quiz-top5" class="hidden bg-yellow-50 p-4 rounded-xl text-left">
                        <h3 class="font-bold text-center text-yellow-700 mb-2">VINH DANH TOP 5</h3>
                        <div id="quiz-top5-list" class="space-y-2"></div>
                    </div>
                </div>
                <div id="quiz-admin-controls" class="hidden mt-6 bg-purple-50 p-4 rounded-xl border border-purple-200">
                    <h3 class="font-bold text-purple-800 mb-3 flex items-center gap-2"><i data-lucide="crown"></i> Qu·∫£n Tr·ªã Cu·ªôc Thi</h3>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="app.quizAdmin('prepare')" class="bg-gray-500 text-white py-2 rounded-lg font-bold text-sm hover:bg-gray-600">Chu·∫©n b·ªã</button>
                        <button onclick="app.openQuizEditor()" class="bg-blue-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-blue-700">So·∫°n C√¢u H·ªèi</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="app.quizAdmin('start')" class="bg-green-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-green-700">B·∫Øt ƒë·∫ßu Thi</button>
                        <button onclick="app.quizAdmin('stop')" class="bg-red-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-red-700">D·ª´ng & T·ªïng K·∫øt</button>
                    </div>
                    <div class="bg-white p-3 rounded-lg max-h-60 overflow-y-auto">
                        <h4 class="text-xs font-bold text-gray-500 mb-2">B·∫¢NG ƒêI·ªÇM TR·ª∞C TUY·∫æN</h4>
                        <div id="quiz-live-score" class="space-y-1 text-sm"></div>
                    </div>
                </div>
                <div id="quiz-editor" class="hidden fixed inset-0 z-[60] bg-gray-50 overflow-y-auto p-4">
                    <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl mt-10">
                        <div class="flex justify-between mb-4">
                            <h2 class="text-xl font-bold text-purple-800">So·∫°n B·ªô ƒê·ªÅ</h2>
                            <button onclick="document.getElementById('quiz-editor').classList.add('hidden')" class="text-gray-500 font-bold">ƒê√≥ng</button>
                        </div>
                        <div id="editor-questions-list" class="space-y-6 mb-6"></div>
                        <button onclick="app.addEditorQuestion()" class="w-full py-3 border-2 border-dashed border-purple-300 text-purple-600 font-bold rounded-xl hover:bg-purple-50 mb-4">+ Th√™m C√¢u H·ªèi</button>
                        <button onclick="app.saveQuizQuestions()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 shadow-lg">L∆∞u B·ªô ƒê·ªÅ</button>
                        <button onclick="app.deleteAllQuestions()" class="w-full mt-3 py-3 bg-red-100 text-red-600 font-bold rounded-xl hover:bg-red-200 border border-red-200">‚ö†Ô∏è X√≥a To√†n B·ªô C√¢u H·ªèi C≈©</button>
                    </div>
                </div>
            </div>

            <div id="shop-container" class="hidden space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-lg border border-orange-200">
                    <h3 class="font-bold text-orange-700 mb-4 flex items-center gap-2"><i data-lucide="store"></i> C·ª≠a H√†ng V·∫≠t Ph·∫©m</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="shop-item">
                            <div class="w-16 h-16 rounded-full border-4 border-gray-300 mx-auto mb-2 shadow-lg relative bg-gray-100 frame-silver"></div>
                            <h4 class="font-bold text-sm">Khung B·∫°c</h4>
                            <p class="text-xs text-yellow-600 font-bold mb-2">500 Xu</p>
                            <button onclick="app.buyItem('frame_silver', 500)" class="shop-btn btn-buy">ƒê·ªïi ngay</button>
                        </div>
                        <div class="shop-item">
                            <div class="w-16 h-16 rounded-full border-4 border-yellow-400 mx-auto mb-2 shadow-lg relative bg-yellow-50 frame-gold"></div>
                            <h4 class="font-bold text-sm">Khung V√†ng</h4>
                            <p class="text-xs text-yellow-600 font-bold mb-2">1000 Xu</p>
                            <button onclick="app.buyItem('frame_gold', 1000)" class="shop-btn btn-buy">ƒê·ªïi ngay</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-lg border border-blue-200">
                    <h3 class="font-bold text-blue-700 mb-4 flex items-center gap-2"><i data-lucide="backpack"></i> T√∫i ƒê·ªì C·ªßa B·∫°n</h3>
                    <div id="inventory-list" class="grid grid-cols-1 gap-2 text-sm text-gray-500 italic">Ch∆∞a c√≥ v·∫≠t ph·∫©m n√†o.</div>
                </div>
            </div>

            <div id="admin-panel" class="hidden space-y-6">
                <div class="bg-yellow-50 p-5 rounded-2xl shadow-sm border border-yellow-200">
                    <h3 class="font-bold text-yellow-800 mb-3"><i data-lucide="gift"></i> T·∫∑ng ƒêi·ªÉm Th∆∞·ªüng (Xu)</h3>
                    <select id="reward-student-select" class="w-full p-3 mb-2 rounded-xl border bg-white text-sm"><option value="">-- Ch·ªçn h·ªçc sinh --</option></select>
                    <input type="number" id="reward-amount" placeholder="S·ªë xu (VD: 50)" class="w-full p-3 mb-2 rounded-xl border bg-white text-sm">
                    <input type="text" id="reward-reason" placeholder="L√Ω do (VD: L√†m vi·ªác t·ªët)" class="w-full p-3 mb-2 rounded-xl border bg-white text-sm">
                    <button onclick="app.adminGiveCoins()" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition shadow">T·∫∑ng Xu</button>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-purple-100">
                    <h3 class="font-bold text-purple-800 mb-3">T·∫°o T√†i Kho·∫£n Nhanh</h3>
                    <p class="text-sm text-gray-500 mb-3">File text (.txt): H·ªç t√™n, YYYY-MM-DD</p>
                    <input type="file" id="bulk-user-file" accept=".csv, .txt" class="w-full p-3 mb-3 rounded-xl border bg-gray-50 text-sm">
                    <button onclick="app.bulkCreateUsers()" id="btn-bulk-create" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition disabled:opacity-50">Th·ª±c Hi·ªán T·∫°o H√†ng Lo·∫°t</button>
                    <p id="bulk-status" class="mt-2 text-sm hidden font-bold"></p>
                    <hr class="my-4">
                    <h3 class="font-bold text-purple-800 mb-3">Th√™m H·ªçc Sinh (Th·ªß C√¥ng)</h3>
                    <input id="new-u" class="w-full p-3 mb-2 rounded-xl border bg-gray-50 text-sm" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                    <input id="new-p" type="password" class="w-full p-3 mb-2 rounded-xl border bg-gray-50 text-sm" placeholder="M·∫≠t kh·∫©u">
                    <input id="new-n" class="w-full p-3 mb-2 rounded-xl border bg-gray-50 text-sm" placeholder="H·ªç t√™n">
                    <input id="new-d" type="date" class="w-full p-3 mb-2 rounded-xl border bg-gray-50 text-sm">
                    <button onclick="app.createUser()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition">T·∫°o T√†i Kho·∫£n</button>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-3">Danh S√°ch L·ªõp</h3>
                    <div id="user-list" class="space-y-2 text-sm">Loading...</div>
                </div>
            </div>
            
            <div id="settings-panel" class="hidden space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-cyan-100">
                    <h3 class="font-bold text-cyan-800 mb-4 flex items-center gap-2"><i data-lucide="user-circle"></i> Th√¥ng Tin</h3>
                    <div class="flex flex-col items-center mb-4">
                        <div class="relative mb-3">
                            <img id="avatar-preview" class="w-24 h-24 object-cover rounded-full border-4 border-white shadow-lg bg-gray-200" src="" alt="Avatar">
                            <label class="absolute bottom-0 right-0 bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-full cursor-pointer shadow-md transition"><i data-lucide="camera" width="16"></i><input type="file" id="avatar-file-input" accept="image/*" class="hidden" onchange="app.updateAvatar(this.files[0])"></label>
                        </div>
                        <p id="settings-user-name" class="font-bold text-lg text-slate-800"></p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-cyan-100">
                    <h3 class="font-bold text-cyan-800 mb-3 flex items-center gap-2"><i data-lucide="lock"></i> ƒê·ªïi M·∫≠t Kh·∫©u</h3>
                    <input id="new-password" type="password" class="w-full p-3 mb-2 rounded-xl border bg-gray-50 text-sm" placeholder="M·∫≠t kh·∫©u m·ªõi">
                    <input id="confirm-password" type="password" class="w-full p-3 mb-3 rounded-xl border bg-gray-50 text-sm" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                    <button onclick="app.changePassword()" id="btn-change-pass" class="w-full py-3 bg-cyan-600 text-white font-bold rounded-xl hover:bg-cyan-700 transition">L∆∞u M·∫≠t Kh·∫©u</button>
                </div>
            </div>

            <div id="post-form" class="hidden mb-6 bg-white p-4 rounded-2xl shadow-lg border border-gray-100 relative z-10">
                <textarea id="post-content" rows="3" class="w-full bg-transparent outline-none text-gray-700 placeholder-gray-400 text-base" placeholder="Vi·∫øt g√¨ ƒë√≥..."></textarea>
                <div id="preview-area" class="hidden mt-2 relative w-full h-48">
                    <img id="img-preview" class="w-full h-full object-cover rounded-lg border">
                    <button onclick="app.clearImg()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center">√ó</button>
                </div>
                <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                    <label class="flex items-center gap-2 text-indigo-600 font-bold text-sm cursor-pointer hover:bg-indigo-50 px-3 py-2 rounded-lg transition"><i data-lucide="image" width="18"></i> <span>Th√™m ·∫¢nh</span><input type="file" id="file-input" accept="image/*" class="hidden" onchange="app.handleImg(this)"></label>
                    <button onclick="app.post()" id="btn-post" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold text-sm hover:bg-indigo-700 disabled:opacity-50 transition shadow-md">ƒêƒÉng</button>
                </div>
            </div>

            <div id="star-admin-form" class="hidden mb-6 bg-yellow-50 p-5 rounded-2xl shadow-lg border-2 border-yellow-300 relative z-10">
                <h3 class="font-bold text-yellow-800 mb-3 flex items-center gap-2"><i data-lucide="award"></i> T·∫°o B·∫£ng Vinh Danh</h3>
                <input id="star-title" class="w-full p-3 mb-4 rounded-xl border border-yellow-200 bg-white text-slate-800" placeholder="Ti√™u ƒë·ªÅ (V√≠ d·ª•: Vinh Danh Tu·∫ßn 1)">
                <div id="star-student-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-60 overflow-y-auto mb-4 bg-white p-2 rounded-xl border"></div>
                <button onclick="app.postStarBoard()" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition shadow">ƒêƒÉng B·∫£ng Vinh Danh</button>
            </div>

            <div id="feed" class="space-y-4 pb-10"></div>
            
            <div id="pagination-controls" class="hidden flex justify-center items-center gap-4 mt-6 pb-10">
    <button onclick="window.app.changePage(-1)" id="btn-prev-page" class="px-4 py-2 bg-white text-indigo-600 font-bold rounded-lg shadow border border-indigo-100 hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-1">
        <i data-lucide="chevron-left" width="16"></i> Tr∆∞·ªõc
    </button>
    
    <span id="page-indicator" class="font-bold text-slate-600 bg-white px-4 py-2 rounded-lg shadow-sm border">Trang 1</span>
    
    <button onclick="window.app.changePage(1)" id="btn-next-page" class="px-4 py-2 bg-white text-indigo-600 font-bold rounded-lg shadow border border-indigo-100 hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-1">
        Ti·∫øp <i data-lucide="chevron-right" width="16"></i>
    </button>
</div>
        </div>
    </div>



<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
// Th√™m d√≤ng n√†y ƒë·ªÉ d√πng tr√≠ tu·ªá nh√¢n t·∫°o

    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, arrayUnion, arrayRemove, getDocs, where, setDoc, getDoc, limit, startAfter, increment, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBNemOkL1Y3p2CSH8dw3zfq1vFe9XXNDTM",
        authDomain: "nhat-ky-lop-2a8-bc084.firebaseapp.com",
        projectId: "nhat-ky-lop-2a8-bc084",
        storageBucket: "nhat-ky-lop-2a8-bc084.firebasestorage.app",
        messagingSenderId: "292137730998",
        appId: "1:292137730998:web:229f5fce1e756f7ba37717"
    };

firebase.initializeApp(firebaseConfig);

    let db, auth, currentUser = null;
    let currentTab = '';
    const appId = 'class-2a8-v1';
// --- D√ÅN M√É API C·ª¶A B·∫†N V√ÄO ƒê√ÇY ---
   // --- D√ÅN M√É API C·ª¶A B·∫†N V√ÄO ƒê√ÇY ---

    const USER_STORAGE_KEY = '2a8_currentUser'; 
    const APP_CONFIG_DOC = (db) => doc(db, `artifacts/${appId}/config`, 'main');
    const QUIZ_GLOBAL_DOC = (db) => doc(db, `artifacts/${appId}/quiz_state`, 'main');
    const QUIZ_DATA_DOC = (db) => doc(db, `artifacts/${appId}/quiz_data`, 'questions');
    const BANNER_KEY = 'bannerUrl';
    
    // C·∫•u h√¨nh Ph√¢n Trang
    const POSTS_PER_PAGE = 10; 
    let currentPage = 1;       
    let pageCursors = {};      
    
    let unsubscribeFeed = null; 
    let unsubscribeChat = null; 
    let newNotifs = [];
    const COMMENT_EMOJIS = ["üëç", "‚ù§Ô∏è", "üòä", "üòÇ", "ü•∞", "üéâ", "üåü", "üåπ", "üê±", "üê∂", "üí™", "üåà", "üçé", "‚öΩ", "üëè"];

    // Bi·∫øn cho Game & Quiz
    let activeQuestions = [];
    let quizTimer = null;
    let quizTimeLeft = 20;
    let currentQIndex = 0;
    let currentScore = 0;
    let quizStatusListener = null;
    let quizLiveScoreListener = null;
    let selectedTempPet = '';
    let petWanderTimeout = null;

    const compressImage = async (file, maxWidth = 1024, quality = 0.8) => { return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', quality); }; }; }); };
    const removeDiacritics = (str) => { if (!str) return ''; str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D"); return str; };
    
    const getAvatarHtml = (uid, avatarUrl, size = 'w-8 h-8', extraClass='') => {
        let frameClass = '';
        if (uid && window.app.userCache[uid] && window.app.userCache[uid].frame) {
            if (window.app.userCache[uid].frame === 'frame_silver') frameClass = 'frame-silver';
            if (window.app.userCache[uid].frame === 'frame_gold') frameClass = 'frame-gold';
        }
        const src = avatarUrl || 'https://via.placeholder.com/32';
        return `<img src="${src}" class="${size} rounded-full object-cover shrink-0 ${frameClass} framed-avatar ${extraClass} m-0.5">`;
    };

    const init = async () => {
        lucide.createIcons();
        applySeasonalTheme();
// --- TH√äM D√íNG N√ÄY ƒê·ªÇ T·ª∞ ƒê·ªòNG KI·ªÇM TRA M·ªñI 1 PH√öT ---
        setInterval(() => {
            if(currentUser && currentUser.pet) window.app.checkPetStatus();
        }, 60000);
        if (!firebaseConfig.apiKey) { document.getElementById('config-warning').classList.remove('hidden'); return; }
        try {
            const appInstance = initializeApp(firebaseConfig);
            db = getFirestore(appInstance);
            auth = getAuth(appInstance);
            try {
                await signInAnonymously(auth);
                window.app.loadBanner();
                window.app.startUserListener();
                const storedUser = localStorage.getItem(USER_STORAGE_KEY);
                if (storedUser) { currentUser = JSON.parse(storedUser); window.app.onLoginSuccess(); }
            } catch(e) { console.error("Auth Err", e); }
        } catch (e) {}
    };

    const applySeasonalTheme = () => { const today = new Date(); const month = today.getMonth() + 1; const day = today.getDate(); const body = document.body; let icon = ''; let color = ''; let themeClass = ''; let greeting = ''; if (month === 12 && day <= 30) { themeClass = 'theme-xmas'; icon = '‚ùÑÔ∏è'; color = '#fff'; greeting = 'üéÑ Ch√∫c M·ª´ng Gi√°ng Sinh!'; } else if ((month === 1) || (month === 2 && day <= 20)) { themeClass = 'theme-tet'; icon = 'üå∏'; color = '#ffb7b2'; greeting = 'üßß Ch√∫c M·ª´ng NƒÉm M·ªõi!'; } if (themeClass) { body.classList.add(themeClass); document.getElementById('seasonal-greeting').textContent = greeting; setInterval(() => { const f = document.createElement('div'); f.innerHTML = icon; f.className = 'falling-item'; f.style.left = Math.random() * 100 + 'vw'; f.style.fontSize = (Math.random() * 1.5 + 0.5) + 'rem'; f.style.color = color; f.style.animationDuration = (Math.random() * 5 + 3) + 's'; document.body.appendChild(f); setTimeout(() => f.remove(), 8000); }, 400); } };
let _cachedGeminiKey = null;
    window.app = {

        userCache: {},
        startUserListener: () => {
            if (!auth.currentUser) return;
            onSnapshot(collection(db, `artifacts/${appId}/users`), (snap) => {
                snap.forEach(doc => { window.app.userCache[doc.id] = doc.data(); });
                if (currentUser && window.app.userCache[currentUser.id]) {
                    const myData = window.app.userCache[currentUser.id];
                    currentUser.coins = myData.coins || 0;
                    currentUser.pet = myData.pet; 
                    const coinEl = document.getElementById('current-coins');
                    if(coinEl) coinEl.textContent = currentUser.coins;
                    if(currentTab === 'shop' && window.app.renderInventory) window.app.renderInventory();
                    if(currentTab === 'petgame') window.app.checkPetStatus();
                }
                window.app.updateOnlineStatus();
            });
        },

        // --- NAVIGATION & PH√ÇN TRANG ---
        nav: (tab) => { 
            currentTab = tab; 
            document.getElementById('post-content').value = ''; 
            window.app.clearImg(); 
            
            if (window.app.unsubscribeFeed) { 
                window.app.unsubscribeFeed(); 
                window.app.unsubscribeFeed = null; 
            } 
            
            document.getElementById('dashboard-view').classList.remove('active-block'); 
            document.getElementById('detail-view').classList.add('active-block'); 
            window.scrollTo(0, 0); 
            
            const titles = { diary: 'Nh·∫≠t K√Ω', pets: 'Th√∫ C∆∞ng', chat: 'H·ªèi ƒê√°p', notif: 'Th√¥ng B√°o', stars: 'H·ªçc Sinh Ngoan', bday: 'Sinh Nh·∫≠t', quiz: 'Thi Tr·∫Øc Nghi·ªám', gift: 'G√≥c ƒê·ªïi Qu√†', admin: 'Qu·∫£n L√Ω', settings: 'C√†i ƒê·∫∑t', shop: 'G√≥c ƒê·ªïi Qu√†', petgame: 'Nu√¥i Th√∫ ·∫¢o', private: 'Nh·∫≠t K√Ω C√° Nh√¢n' }; 
            document.getElementById('page-title').textContent = titles[tab] || 'Chi Ti·∫øt'; 
            
            // ·∫®n t·∫•t c·∫£ c√°c panel
            ['post-form', 'star-admin-form', 'admin-panel', 'settings-panel', 'shop-container', 'petgame-container', 'feed', 'pagination-controls', 'quiz-container'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });

            // Reset n√∫t ·∫£nh
            const imgLabel = document.querySelector('#post-form label');
            if(imgLabel) imgLabel.classList.remove('hidden'); 
            document.getElementById('post-content').placeholder = "Vi·∫øt g√¨ ƒë√≥...";

            const feedEl = document.getElementById('feed');

            if(tab === 'quiz') { 
                document.getElementById('quiz-container').classList.remove('hidden'); 
                window.app.initQuiz(); 
            } 
            else if (tab === 'private') { 
                document.getElementById('feed').classList.remove('hidden');
                window.app.loadPrivateDiary(); 
            } 
            else if(tab === 'shop') { 
                document.getElementById('shop-container').classList.remove('hidden'); 
                window.app.renderInventory(); 
            } 
            else if(tab === 'petgame') { 
                document.getElementById('petgame-container').classList.remove('hidden'); 
                window.app.renderPetGame(); 
            } 
            else if(tab === 'admin') { 
                if(currentUser.role !== 'admin') { window.app.goHome(); return; } 
                document.getElementById('admin-panel').classList.remove('hidden'); 
                window.app.loadUsers(); 
                window.app.loadStudentsForReward(); 
            } 
            else if (tab === 'settings') { 
                document.getElementById('settings-panel').classList.remove('hidden'); 
                document.getElementById('settings-user-name').textContent = currentUser.name; 
                document.getElementById('avatar-preview').src = currentUser.avatarUrl || 'https://via.placeholder.com/96x96?text=Avt'; 
            } 
            else { 
                feedEl.classList.remove('hidden'); 
                if(currentUser.role === 'admin' || !['notif', 'stars', 'bday'].includes(tab)) { 
                    if (tab === 'stars' && currentUser.role === 'admin') { 
                        document.getElementById('star-admin-form').classList.remove('hidden'); 
                        window.app.loadStudentsForSelection(); 
                    } else { 
                        document.getElementById('post-form').classList.remove('hidden'); 
                    } 
                } 
                if(tab === 'bday') {
                    window.app.loadBday(); 
                } else {
                    window.app.loadFeed(tab, 1); // G·ªçi h√†m ph√¢n trang v·ªõi trang 1
                }
            } 
        },

        // --- H√ÄM T·∫¢I FEED (C√ì PH√ÇN TRANG) ---
        loadFeed: async (tab, page = 1) => { 
            const el = document.getElementById('feed'); 
            const pagiContainer = document.getElementById('pagination-controls'); 
            
            el.innerHTML = '<div class="text-center mt-10"><div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div><p class="text-indigo-600 mt-2 font-bold">ƒêang t·∫£i trang ' + page + '...</p></div>';
            window.scrollTo(0, 0); 

            if (page === 1) {
                currentPage = 1;
                pageCursors = {};
            }

            try { 
                if (window.app.unsubscribeFeed) {
                    window.app.unsubscribeFeed();
                    window.app.unsubscribeFeed = null;
                } 
                
                let q = query(collection(db, `artifacts/${appId}/posts_${tab}`), orderBy('date', 'desc'), limit(POSTS_PER_PAGE));
                
                if (page > 1 && pageCursors[page - 1]) {
                    q = query(collection(db, `artifacts/${appId}/posts_${tab}`), orderBy('date', 'desc'), startAfter(pageCursors[page - 1]), limit(POSTS_PER_PAGE));
                }

                window.app.unsubscribeFeed = onSnapshot(q, (snap) => { 
                    el.innerHTML = ''; 
                    
                    if(pagiContainer) {
                        pagiContainer.classList.remove('hidden');
                        document.getElementById('page-indicator').textContent = `Trang ${page}`;
                        document.getElementById('btn-prev-page').disabled = (page <= 1);
                        document.getElementById('btn-next-page').disabled = (snap.docs.length < POSTS_PER_PAGE);
                    }

                    if (snap.empty) { 
                        el.innerHTML = `<div class="text-center text-gray-400 mt-10 bg-white p-6 rounded-2xl border border-dashed border-gray-300 mx-4"><p>Kh√¥ng c√≥ b√†i vi·∫øt n√†o ·ªü trang n√†y.</p>${page > 1 ? '<button onclick="window.app.changePage(-1)" class="text-indigo-600 font-bold underline mt-2">Quay l·∫°i</button>' : ''}</div>`; 
                        lucide.createIcons();
                        return; 
                    } 
                    
                    pageCursors[page] = snap.docs[snap.docs.length - 1];
                    
                    snap.forEach(doc => { 
                        const d = doc.data(); 
                        const isMine = d.uid === currentUser.id || currentUser.role === 'admin'; 
                        const liked = d.likes?.includes(currentUser.id); 
                        let displayAvatarUrl = d.avatarUrl;
                        if(d.uid === 'admin') displayAvatarUrl = window.app.userCache['admin']?.avatarUrl || d.avatarUrl;
                        else displayAvatarUrl = window.app.userCache[d.uid]?.avatarUrl || d.avatarUrl;
                        const avatarHtml = getAvatarHtml(d.uid, displayAvatarUrl);
                        const emojiBar = `<div class="flex gap-2 overflow-x-auto no-scrollbar py-2 border-b border-gray-100 mb-2">${COMMENT_EMOJIS.map(e => `<span onclick="window.app.addEmojiToCmt('${doc.id}', '${e}')" class="cursor-pointer hover:bg-gray-100 p-1 rounded text-lg select-none">${e}</span>`).join('')}</div>`; 
                        const allComments = d.comments || [];
                        const recentComments = allComments.slice(-4);
                        const renderComments = (comments) => { return comments.map(c => { const cAvatar = getAvatarHtml(c.uid, window.app.userCache[c.uid]?.avatarUrl || 'https://via.placeholder.com/24', 'w-6 h-6'); return `<div class="flex gap-2 items-start mb-2">${cAvatar}<div class="bg-white p-2 rounded-lg shadow-sm flex-1 text-base text-slate-800"><b>${c.user}:</b> ${c.text}</div></div>`; }).join(''); }; 
                        const moreCommentsBtn = allComments.length > 4 ? `<div class="text-center mb-2"><button onclick="document.getElementById('full-cmt-${doc.id}').classList.remove('hidden'); this.remove()" class="text-xs text-indigo-500 font-bold hover:underline">Xem t·∫•t c·∫£ ${allComments.length} b√¨nh lu·∫≠n...</button></div>` : '';
                        const hiddenComments = allComments.length > 4 ? `<div id="full-cmt-${doc.id}" class="hidden">${renderComments(allComments.slice(0, -4))}</div>` : '';

                        const div = document.createElement('div'); 
                        div.className = "mb-4 animate-zoom-in";
                        if (tab === 'stars' && d.type === 'star_board') {
                             div.className = "honor-board mb-6 animate-zoom-in"; 
                             div.innerHTML = `<div class="flex justify-between items-center p-4 bg-gray-50 sticky top-0 z-10 shadow-md"><div class="text-xs text-gray-400">${new Date(d.date).toLocaleDateString('vi-VN')}</div>${isMine ? `<button onclick="window.app.delPost('${tab}','${doc.id}')" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" width="16"></i></button>` : ''}</div><h2 class="honor-header">${d.content}</h2><div class="honor-grid">${(d.students || []).map(s => { const sAvatar = getAvatarHtml(s.id, s.avatarUrl, 'honor-avatar w-20 h-20 !rounded-full !border-4 !border-white shadow-md'); return `<div class="honor-item">${sAvatar}<div class="honor-name">${s.name}</div></div>`; }).join('')}</div><div class="flex gap-4 text-sm text-gray-500 border-t pt-3 mt-4 border-yellow-200"><button onclick="window.app.like('${tab}', '${doc.id}', ${liked})" class="${liked ? 'text-red-500 font-bold' : ''}">‚ù§Ô∏è ${d.likes?.length||0}</button><span>üí¨ ${allComments.length}</span></div><div id="c-${doc.id}" class="mt-3 bg-yellow-50 p-3 rounded-lg border border-yellow-100">${moreCommentsBtn}<div class="space-y-1 mb-2 max-h-60 overflow-y-auto custom-scrollbar">${hiddenComments}${renderComments(recentComments)}</div>${emojiBar}<div class="flex gap-2 mt-2"><input id="cmt-${doc.id}" class="flex-1 border p-2 rounded-lg text-sm bg-white" placeholder="Ch√∫c m·ª´ng c√°c b·∫°n..."><button onclick="window.app.cmtBtn('${tab}', '${doc.id}')" class="text-yellow-600 font-bold text-sm">G·ª≠i</button></div></div>`;
                        } else {
                            div.innerHTML = `<div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4"><div class="flex justify-between items-center p-4 bg-gray-50 sticky top-0 z-10 shadow-md"><div class="flex items-center gap-3">${avatarHtml}<div class="font-bold text-indigo-700 text-sm">${d.author}</div></div>${isMine ? `<button onclick="window.app.delPost('${tab}','${doc.id}')" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" width="16"></i></button>` : ''}</div><div class="text-slate-800 whitespace-pre-wrap mb-2 text-base leading-relaxed break-words">${d.content}</div>${d.image ? `<img src="${d.image}" loading="lazy" class="w-full rounded-lg mb-2 h-auto shadow-sm border bg-gray-50">` : ''}<div class="flex gap-4 text-sm text-gray-500 border-t pt-2 mt-2"><button onclick="window.app.like('${tab}', '${doc.id}', ${liked})" class="${liked ? 'text-red-500 font-bold' : ''}">‚ù§Ô∏è ${d.likes?.length||0}</button><span>üí¨ ${allComments.length}</span></div><div id="c-${doc.id}" class="mt-3 bg-gray-50 p-3 rounded-lg">${moreCommentsBtn}<div class="space-y-1 mb-2 max-h-60 overflow-y-auto custom-scrollbar">${hiddenComments}${renderComments(recentComments)}</div>${emojiBar}<div class="flex gap-2 mt-2"><input id="cmt-${doc.id}" class="flex-1 border p-2 rounded-lg text-sm bg-white" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."><button onclick="window.app.cmtBtn('${tab}', '${doc.id}')" class="text-blue-600 font-bold text-sm">G·ª≠i</button></div></div></div>`;
                        }
                        el.appendChild(div); 
                    }); 
                    lucide.createIcons(); 
                }, (error) => { el.innerHTML = `<div class="text-red-500 bg-white p-4 rounded-xl text-center">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</div>`; }); 
            } catch (e) { console.error("L·ªói:", e); } 
        },

        changePage: (delta) => {
            const newPage = currentPage + delta;
            if (newPage < 1) return; 
            currentPage = newPage;
            window.app.loadFeed(currentTab, currentPage);
        },

        loadPrivateDiary: () => {
            const el = document.getElementById('feed');
            el.innerHTML = '<div class="text-center mt-10"><div class="animate-spin inline-block w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full"></div><p class="text-purple-600 mt-2 font-bold">ƒêang m·ªü cu·ªën nh·∫≠t k√Ω b√≠ m·∫≠t...</p></div>';
            
            document.getElementById('post-form').classList.remove('hidden');
            const imgBtn = document.querySelector('#post-form label');
            if(imgBtn) imgBtn.classList.add('hidden'); 
            document.getElementById('post-content').placeholder = "Ng√†y h√¥m nay c·ªßa con th·∫ø n√†o? (Ch·ªâ con m·ªõi ƒë·ªçc ƒë∆∞·ª£c d√≤ng n√†y)...";
            document.getElementById('pagination-controls').classList.add('hidden'); // ·∫®n ph√¢n trang ·ªü ƒë√¢y theo y√™u c·∫ßu

            if (window.app.unsubscribeFeed) { window.app.unsubscribeFeed(); window.app.unsubscribeFeed = null; }
            
            const q = query(collection(db, `artifacts/${appId}/posts_private`), orderBy('date', 'desc'), limit(50));
            window.app.unsubscribeFeed = onSnapshot(q, (snap) => {
                el.innerHTML = '';
                let myPostsCount = 0;
                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.uid === currentUser.id) {
                        myPostsCount++;
                        const dateStr = new Date(d.date).toLocaleString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const div = document.createElement('div');
                        div.className = "mb-4 animate-zoom-in";
                        div.innerHTML = `<div class="private-note"><div class="flex justify-between items-start"><div class="private-date">üìÖ ${dateStr}</div><button onclick="window.app.delPost('private','${doc.id}')" class="text-gray-400 hover:text-red-500 bg-white/50 rounded-full p-1"><i data-lucide="trash-2" width="14"></i></button></div><div class="text-slate-800 whitespace-pre-wrap break-words text-base font-medium" style="word-break: break-word; overflow-wrap: break-word;">${d.content}</div></div>`;
                        el.appendChild(div);
                    }
                });
                if (myPostsCount === 0) el.innerHTML = `<div class="text-center mt-10 opacity-60"><div class="text-6xl mb-4">üìî</div><p class="text-purple-800 font-bold">Cu·ªën nh·∫≠t k√Ω n√†y ch∆∞a c√≥ trang n√†o.</p><p class="text-sm">H√£y vi·∫øt d√≤ng t√¢m s·ª± ƒë·∫ßu ti√™n ·ªü b√™n tr√™n nh√©!</p></div>`;
                lucide.createIcons();
            });
        },

        // --- C√ÅC H√ÄM KH√ÅC (USER, CHAT, PET, QUIZ) ---
        login: async () => { const u = document.getElementById('username').value.trim(); const p = document.getElementById('password').value.trim(); const err = document.getElementById('login-error'); if(!u || !p) return; try { if (!auth.currentUser) await signInAnonymously(auth); const q = query(collection(db, `artifacts/${appId}/users`), where('username', '==', u)); const snap = await getDocs(q); if (!snap.empty) { const d = snap.docs[0].data(); if (d.password === p) { currentUser = { id: snap.docs[0].id, ...d }; window.app.onLoginSuccess(); } else { err.textContent = "Sai m·∫≠t kh·∫©u!"; err.classList.remove('hidden'); } } else { if(u === 'admin' && p === 'admin') { const adminRef = doc(db, `artifacts/${appId}/users`, 'admin'); const adminSnap = await getDoc(adminRef); let adminData = { username: 'admin', password: 'admin', name: 'C√¥ Gi√°o', role: 'admin', dob: '' }; if(adminSnap.exists()) { adminData = { ...adminData, ...adminSnap.data() }; } else { adminData.avatarUrl = ''; } await setDoc(adminRef, adminData, {merge:true}); currentUser = { id: 'admin', ...adminData }; window.app.onLoginSuccess(); } else { err.textContent = "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n!"; err.classList.remove('hidden'); } } } catch(e) { err.textContent = "L·ªói k·∫øt n·ªëi: " + e.message; err.classList.remove('hidden'); } },
        onLoginSuccess: () => { localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(currentUser)); document.getElementById('login-view').classList.remove('active-flex'); document.getElementById('dashboard-view').classList.add('active-block'); document.getElementById('user-name').textContent = currentUser.name; document.getElementById('admin-card').classList.toggle('hidden', currentUser.role !== 'admin'); document.getElementById('btn-clear-chat').classList.toggle('hidden', currentUser.role !== 'admin'); document.getElementById('user-balance-display').classList.remove('hidden'); document.getElementById('current-coins').textContent = currentUser.coins || 0; window.app.loadBanner(); window.app.loadChat(); window.app.checkCheckInStatus(); window.app.checkNotifications(); window.app.reportOnline(); setInterval(window.app.reportOnline, 30000); },
        logout: () => { if(confirm("ƒêƒÉng xu·∫•t?")) { localStorage.removeItem(USER_STORAGE_KEY); location.reload(); } },
        goHome: () => { if (unsubscribeFeed) { unsubscribeFeed(); unsubscribeFeed = null; } document.getElementById('detail-view').classList.remove('active-block'); document.getElementById('dashboard-view').classList.add('active-block'); window.scrollTo(0,0); },
        
        loadChat: () => { if(unsubscribeChat) unsubscribeChat(); const q = query(collection(db, `artifacts/${appId}/chat`), orderBy('date', 'desc'), limit(75)); unsubscribeChat = onSnapshot(q, (snap) => { const chatBox = document.getElementById('chat-messages'); chatBox.innerHTML = ''; if (snap.empty) { chatBox.innerHTML = '<div class="text-center text-gray-400 text-xs mt-2">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</div>'; return; } const msgs = []; snap.forEach(doc => msgs.push(doc.data())); msgs.reverse(); msgs.forEach(m => { const isMine = m.uid === currentUser.id; const row = document.createElement('div'); row.className = `chat-row ${isMine ? 'mine' : 'theirs'}`; let avatarUrl = 'https://via.placeholder.com/32?text=U'; if(m.uid === 'admin' || m.user === 'C√¥ Gi√°o') { avatarUrl = window.app.userCache['admin']?.avatarUrl || avatarUrl; } else { avatarUrl = window.app.userCache[m.uid]?.avatarUrl || avatarUrl; } const avatarImg = `<img src="${avatarUrl}" class="chat-avatar" title="${m.user}">`; if (isMine) { row.innerHTML = `<div class="chat-msg mine">${m.text}</div>${avatarImg}`; } else { row.innerHTML = `${avatarImg}<div class="flex flex-col"><span class="text-[10px] text-gray-500 ml-1 mb-0.5">${m.user}</span><div class="chat-msg theirs">${m.text}</div></div>`; } chatBox.appendChild(row); }); chatBox.scrollTop = chatBox.scrollHeight; }); },
        sendChat: async () => { const inp = document.getElementById('chat-input'); const text = inp.value.trim(); if(!text) return; try { await addDoc(collection(db, `artifacts/${appId}/chat`), { text: text, user: currentUser.name, uid: currentUser.id, avatar: currentUser.avatarUrl || '', date: new Date().toISOString() }); inp.value = ''; } catch(e) { alert("L·ªói g·ª≠i tin: " + e.message); } },
        addEmojiToChat: (emoji) => { const inp = document.getElementById('chat-input'); inp.value += emoji; inp.focus(); },
        addEmojiToCmt: (id, emoji) => { const inp = document.getElementById(`cmt-${id}`); if(inp) { inp.value += emoji; inp.focus(); } },
        clearChat: async () => { if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠ chat?")) { const q = query(collection(db, `artifacts/${appId}/chat`)); const snap = await getDocs(q); snap.forEach(async (d) => await deleteDoc(d.ref)); } },

        // PET GAME
        openGratitudeTree: async () => { document.getElementById('gratitude-screen').classList.remove('hidden'); window.app.loadGratitudeFruits(); },
        loadGratitudeFruits: async () => { const container = document.getElementById('tree-fruits-container'); container.innerHTML = ''; try { const q = query(collection(db, `artifacts/${appId}/gratitude_tree`), orderBy('date', 'desc'), limit(50)); const snap = await getDocs(q); snap.forEach(doc => { const data = doc.data(); data.id = doc.id; window.app.renderFruit(data); }); } catch (e) { console.error("L·ªói t·∫£i c√¢y:", e); } },
        renderFruit: (data) => { const container = document.getElementById('tree-fruits-container'); const btn = document.createElement('button'); btn.id = 'fruit-' + data.id; btn.className = "absolute text-2xl md:text-3xl hover:scale-125 transition duration-300 cursor-pointer animate-bounce-slow drop-shadow-lg pointer-events-auto"; btn.innerHTML = "üçé"; btn.style.left = data.x + "%"; btn.style.top = data.y + "%"; btn.onclick = () => { document.getElementById('gratitude-view-content').textContent = `"${data.content}"`; document.getElementById('gratitude-view-author').textContent = `- ${data.author} -`; const modal = document.getElementById('gratitude-view-modal'); const delBtn = document.getElementById('btn-delete-fruit'); if (currentUser && currentUser.role === 'admin') { delBtn.classList.remove('hidden'); delBtn.onclick = () => window.app.deleteGratitudeFruit(data.id, btn.id); } else { delBtn.classList.add('hidden'); } modal.classList.remove('hidden'); }; container.appendChild(btn); },
        postGratitude: async () => { const content = document.getElementById('gratitude-content').value.trim(); if (!content) return alert("B·∫°n ch∆∞a vi·∫øt g√¨ c·∫£!"); const finalX = 10 + (Math.random() * 80); const finalY = 5 + (Math.random() * 55); const newFruit = { content: content, author: currentUser.name, uid: currentUser.id, date: new Date().toISOString(), x: finalX, y: finalY }; try { const docRef = await addDoc(collection(db, `artifacts/${appId}/gratitude_tree`), newFruit); newFruit.id = docRef.id; window.app.renderFruit(newFruit); document.getElementById('gratitude-content').value = ''; document.getElementById('gratitude-input-modal').classList.add('hidden'); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); } catch (e) { console.error(e); alert("L·ªói khi treo qu·∫£: " + e.message); } },
        deleteGratitudeFruit: async (docId, fruitElementId) => { if (!docId) return; if (!confirm("C√¥ gi√°o c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a qu·∫£ t√°o n√†y kh√¥ng?")) return; try { await deleteDoc(doc(db, `artifacts/${appId}/gratitude_tree`, docId)); document.getElementById('gratitude-view-modal').classList.add('hidden'); const fruitElement = document.getElementById(fruitElementId); if(fruitElement) { fruitElement.style.transition = "all 0.5s"; fruitElement.style.transform = "scale(0)"; setTimeout(() => fruitElement.remove(), 500); } } catch (e) { alert("L·ªói khi x√≥a: " + e.message); } },
        
        selectPetType: (type) => { selectedTempPet = type; document.querySelectorAll('.pet-select-card').forEach(el => el.classList.remove('selected')); document.getElementById(`sel-${type}`).classList.add('selected'); },
        confirmPetSelection: async () => { const petName = document.getElementById('pet-name-input').value.trim(); const prices = { 'dog': 100, 'cat': 150, 'bunny': 200 }; if (!selectedTempPet) return alert("Vui l√≤ng ch·ªçn 1 con v·∫≠t!"); if (!petName) return alert("ƒê·∫∑t t√™n cho b√© nh√©!"); if (currentUser.coins < prices[selectedTempPet]) return alert(`B·∫°n c·∫ßn ${prices[selectedTempPet]} Xu ƒë·ªÉ nh·∫≠n nu√¥i b√© n√†y!`); if(confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën nh·∫≠n nu√¥i v·ªõi gi√° ${prices[selectedTempPet]} Xu?`)) { try { const petData = { type: selectedTempPet, name: petName, level: 1, exp: 0, hunger: 100, fun: 100, hygiene: 100, lastInteraction: Date.now(), accessory: null }; await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { pet: petData, coins: increment(-prices[selectedTempPet]) }); alert("Ch√∫c m·ª´ng b·∫°n ƒë√£ nh·∫≠n nu√¥i th√∫ c∆∞ng!"); window.app.renderPetGame(); } catch(e) { alert("L·ªói: " + e.message); } } },
        checkPetStatus: async () => {
            if(!currentUser || !currentUser.pet) { window.app.renderPetGame(); return; }
            const p = currentUser.pet;
            if(p.isDead) { window.app.renderPetGame(); return; }

            const now = Date.now();
            
            // --- S·ª¨A L·ªñI QUAN TR·ªåNG: L∆ØU M·ªêC TH·ªúI GIAN NGAY L·∫¨P T·ª®C ---
            if (!p.lastInteraction) {
                console.log("Kh·ªüi t·∫°o m·ªëc th·ªùi gian cho th√∫ c∆∞ng...");
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { 
                        "pet.lastInteraction": now 
                    });
                    currentUser.pet.lastInteraction = now; // C·∫≠p nh·∫≠t lu√¥n bi·∫øn local
                } catch(e) { console.error("L·ªói init time:", e); }
                return; // ƒê·ª£i v√≤ng ki·ªÉm tra sau
            }

            // T√≠nh s·ªë ph√∫t ƒë√£ tr√¥i qua
            const minutesPassed = (now - p.lastInteraction) / 60000; // 60000ms = 1 ph√∫t
            const DECAY_TIME = 10; // C·∫•u h√¨nh: 10 ph√∫t gi·∫£m 1 l·∫ßn

            if (minutesPassed >= DECAY_TIME) {
                // T√≠nh s·ªë ƒëi·ªÉm c·∫ßn tr·ª´ (L√†m tr√≤n xu·ªëng)
                const reduction = Math.floor(minutesPassed / DECAY_TIME);
                
                if (reduction > 0) {
                    let newHunger = Math.max(0, (p.hunger || 100) - reduction);
                    let newFun = Math.max(0, (p.fun || 100) - reduction);
                    let newHygiene = Math.max(0, (p.hygiene || 100) - reduction);
                    let isDead = newHunger <= 0;

                    try {
                        await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { 
                            "pet.hunger": newHunger, 
                            "pet.fun": newFun, 
                            "pet.hygiene": newHygiene, 
                            "pet.isDead": isDead,
                            "pet.lastInteraction": now // Reset m·ªëc th·ªùi gian v·ªÅ hi·ªán t·∫°i
                        });
                        
                        // C·∫≠p nh·∫≠t local ƒë·ªÉ hi·ªÉn th·ªã ngay
                        currentUser.pet.hunger = newHunger;
                        currentUser.pet.fun = newFun;
                        currentUser.pet.hygiene = newHygiene;
                        currentUser.pet.isDead = isDead;
                        currentUser.pet.lastInteraction = now;
                        
                        console.log(`ƒê√£ gi·∫£m ${reduction} ƒëi·ªÉm sau ${Math.floor(minutesPassed)} ph√∫t.`);
                    } catch(e) {
                        console.error("L·ªói c·∫≠p nh·∫≠t ch·ªâ s·ªë:", e);
                    }
                }
            }
            window.app.renderPetGame();
        },
        renderPetGame: () => { const p = currentUser.pet; const setup = document.getElementById('pet-select-screen'); const main = document.getElementById('pet-main-screen'); if(!p) { setup.classList.remove('hidden'); main.classList.add('hidden'); return; } setup.classList.add('hidden'); main.classList.remove('hidden'); const images = { cat: 'https://i.pinimg.com/originals/9e/6d/c0/9e6dc0a2a7f7924dd040854a7fbcb988.gif', dog: 'https://i.pinimg.com/originals/1a/ad/ea/1aadea234ad1b805c2d39cd892abdfad.gif', bunny: 'https://i.pinimg.com/originals/3a/0e/11/3a0e1105df06e7a3a24d0229920fb1d3.gif' }; const bg = document.getElementById('pet-stage-bg'); if (p.type && images[p.type]) { const bgs = { cat: 'url("https://png.pngtree.com/thumb_back/fh260/background/20211114/pngtree-bright-orange-living-room-illustration-image_916011.png")', dog: 'url("https://img.freepik.com/vector-cao-cap/minh-hoa-vector-ve-noi-that-phong-khach-tuyet-dep-canh-hoat-hinh-ve-phong-khach-voi-cua-so-ghe-sofa-goi-tua-hinh-anh-ban-tron-binh-hoa-va-cau-thang-len-tang-hai_812561-961.jpg")', bunny: 'url("https://png.pngtree.com/thumb_back/fh260/background/20220525/pngtree-cartoon-forest-environment-illstration-image_1401354.jpg")' }; bg.style.backgroundImage = bgs[p.type]; const petEl = document.getElementById('pet-display'); const currentUrl = petEl.style.backgroundImage; const newUrl = `url("${images[p.type]}")`; if(currentUrl !== newUrl && currentUrl !== newUrl.replace(/"/g, "'")) { petEl.style.backgroundImage = newUrl; } } const petEl = document.getElementById('pet-display'); if(p.isDead) { document.getElementById('pet-dead-overlay').classList.remove('hidden'); petEl.classList.add('pet-dead'); window.app.stopPetWandering(); } else { document.getElementById('pet-dead-overlay').classList.add('hidden'); petEl.classList.remove('pet-dead'); window.app.startPetWandering(); } document.getElementById('pet-name-display').textContent = p.name; document.getElementById('pet-level').textContent = p.level || 1; document.getElementById('pet-exp').textContent = `${Math.floor(p.exp||0)}/100`; const setBar = (id, v) => { const val = Math.max(0, Math.min(100, v || 0)); document.getElementById('bar-'+id).style.width = `${val}%`; document.getElementById('val-'+id).textContent = `${Math.floor(val)}%`; }; setBar('hunger', p.hunger); setBar('fun', p.fun); setBar('hygiene', p.hygiene); window.app.renderPetWaste(p.hygiene || 0); },
        renderPetWaste: (hygiene) => { const container = document.getElementById('pet-waste-container'); if (!container) return; container.innerHTML = ''; const h = Number(hygiene) || 0; const wasteCount = Math.floor((100 - h) / 10); for (let i = 0; i < wasteCount; i++) { const poop = document.createElement('span'); poop.innerHTML = 'üí©'; poop.className = 'absolute text-3xl drop-shadow-md animate-bounce'; const fixedX = 15 + ((i * 15) % 70); const fixedY = 75 + ((i % 2) * 5); poop.style.left = fixedX + '%'; poop.style.top = fixedY + '%'; poop.style.zIndex = "30"; poop.style.position = "absolute"; container.appendChild(poop); } },
        startPetWandering: () => { 
            if (window.app.petWanderTimeout) { 
                clearTimeout(window.app.petWanderTimeout); 
                window.app.petWanderTimeout = null; 
            } 
            const petEl = document.getElementById('pet-display'); 
            const accEl = document.getElementById('pet-accessory-display'); 
            
            const loop = () => { 
                if(document.getElementById('pet-main-screen').classList.contains('hidden')) return; 
                
                const p = currentUser.pet; 
                if(!p || p.isDead) return; 
                
                const funLevel = Number(p.fun) || 0; 
                if (funLevel <= 0) return; 
                
                // 1. T√≠nh to√°n v·ªã tr√≠ ng·∫´u nhi√™n
                const randomLeft = Math.floor(Math.random() * 70) + 10; 
                const randomBottom = Math.floor(Math.random() * 40) + 10; 
                
                // 2. T√≠nh to√°n t·ªâ l·ªá ph√≥ng to theo C·∫§P ƒê·ªò (Logic m·ªõi th√™m v√†o)
                // C·∫•p 1 = 1.0, C·∫•p 10 = 2.0. Sau c·∫•p 10 gi·ªØ nguy√™n 2.0
                const currentLevel = p.level || 1;
                const levelScaleMultiplier = 1 + ((Math.min(currentLevel, 10) - 1) / 9); 

                // 3. K·∫øt h·ª£p v·ªõi hi·ªáu ·ª©ng xa g·∫ßn (Depth)
                const depthScale = 1 - (randomBottom / 100); 
                
                // T·ªïng h·ª£p k√≠ch th∆∞·ªõc cu·ªëi c√πng
                const finalScale = depthScale * levelScaleMultiplier;

                // X·ª≠ l√Ω quay m·∫∑t tr√°i/ph·∫£i
                const currentLeft = parseInt(petEl.style.left) || 50; 
                const transformScaleX = randomLeft > currentLeft ? 1 : -1; 

                // √Åp d·ª•ng v√†o th√∫ c∆∞ng
                petEl.style.left = `${randomLeft}%`; 
                petEl.style.bottom = `${randomBottom}px`; 
                petEl.style.transform = `scale(${finalScale}) scaleX(${transformScaleX})`; 
                
                // √Åp d·ª•ng v√†o ph·ª• ki·ªán (n·∫øu c√≥)
                if(accEl) { 
                    accEl.style.left = `${randomLeft}%`; 
                    accEl.style.bottom = `${randomBottom + 50 * levelScaleMultiplier}px`; // ƒêi·ªÅu ch·ªânh ƒë·ªô cao ph·ª• ki·ªán theo k√≠ch th∆∞·ªõc th√∫
                    accEl.style.transform = `scale(${finalScale}) scaleX(${transformScaleX})`; 
                } 
                
                const delay = 3000 + ((100 - funLevel) * 100); 
                window.app.petWanderTimeout = setTimeout(loop, delay); 
            }; 
            loop(); 
        },
        stopPetWandering: () => { if(window.app.petWanderTimeout) { clearTimeout(window.app.petWanderTimeout); window.app.petWanderTimeout = null; } },
        animatePetClick: () => { const petEl = document.getElementById('pet-display'); if (!petEl) return; petEl.classList.add('pet-zoom-wobble'); setTimeout(() => { petEl.classList.remove('pet-zoom-wobble'); }, 4000); },
        toggleFoodMenu: () => { document.getElementById('pet-food-menu').classList.toggle('hidden'); },
        buyPetItem: async (price, type, val) => { 
            const currentMoney = window.app.userCache[currentUser.id].coins || 0; 
            if(currentMoney < price) return alert(`B·∫°n kh√¥ng ƒë·ªß xu!`); 
            
            const p = currentUser.pet; 
            const currentStat = parseInt(p[type] || 0); 
            if(currentStat >= 100) return alert("Th√∫ c∆∞ng ƒë√£ ƒë·ªß ch·ªâ s·ªë n√†y!"); 
            
            try { 
                let newVal = Math.min(100, currentStat + val); 
                let newExp = (p.exp || 0) + 5; 
                let newLevel = p.level; 
                
                if(newExp >= 100) { 
                    newExp = 0; 
                    newLevel++; 
                    alert(`üéâ Ch√∫c m·ª´ng! Th√∫ c∆∞ng l√™n c·∫•p ${newLevel}!`); 
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); 
                } 

                await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { 
                    coins: increment(-price), 
                    [`pet.${type}`]: newVal, 
                    "pet.exp": newExp, 
                    "pet.level": newLevel, 
                    "pet.lastInteraction": Date.now() // <--- S·ª¨A L·∫†I T√äN BI·∫æN N√ÄY CHO KH·ªöP
                }); 
                
                document.getElementById('pet-food-menu').classList.add('hidden'); 
                const petEl = document.getElementById('pet-display'); 
                petEl.classList.add('pet-eating'); 
                setTimeout(()=>petEl.classList.remove('pet-eating'), 2000); 
                
                // C·∫≠p nh·∫≠t local ngay l·∫≠p t·ª©c
                currentUser.coins -= price; 
                currentUser.pet[type] = newVal;
                currentUser.pet.exp = newExp;
                currentUser.pet.level = newLevel;
                currentUser.pet.lastInteraction = Date.now();
                
                document.getElementById('current-coins').textContent = currentUser.coins; 
                window.app.renderPetGame();

            } catch(e) { 
                console.error(e); 
                alert("L·ªói: " + e.message); 
            } 
        },
        playPet: () => { window.app.buyPetItem(0, 'fun', 10); window.app.animatePetClick(); },
        cleanPet: () => { window.app.buyPetItem(0, 'hygiene', 20); },
        revivePet: async () => { if(currentUser.coins < 300) return alert("C·∫ßn 300 xu ƒë·ªÉ h·ªìi sinh!"); if(confirm("D√πng 300 xu ƒë·ªÉ h·ªìi sinh?")) { try { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { coins: increment(-300), "pet.isDead": false, "pet.hunger": 50, "pet.fun": 50, "pet.hygiene": 50 }); alert("Th√∫ c∆∞ng ƒë√£ s·ªëng l·∫°i!"); window.app.renderPetGame(); } catch(e) { alert(e.message); } } },
        resetPet: async () => { if(confirm("M·∫•t h·∫øt c·∫•p ƒë·ªô?")) try { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { pet: null }); } catch(e){} },

        // POSTS & INTERACTION
        post: async () => { if(!db) return; const txt = document.getElementById('post-content').value.trim(); const file = document.getElementById('file-input').files[0]; if(!txt && !file) return; const btn = document.getElementById('btn-post'); btn.textContent = 'ƒêang ƒëƒÉng...'; btn.disabled = true; try { let imgUrl = null; if(file) { const compressedFile = await compressImage(file); const sRef = storageRef(getStorage(), `artifacts/${appId}/posts_${currentTab}/${Date.now()}_compressed.jpg`); const snap = await uploadBytes(sRef, compressedFile); imgUrl = await getDownloadURL(snap.ref); } await addDoc(collection(db, `artifacts/${appId}/posts_${currentTab}`), { content: txt, image: imgUrl, author: currentUser.name, uid: currentUser.id, avatarUrl: currentUser.avatarUrl || '', date: new Date().toISOString(), likes: [], comments: [] }); await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { coins: increment(10) }); document.getElementById('post-content').value = ''; window.app.clearImg(); } catch(e) { alert("L·ªói: " + e.message); } finally { btn.textContent = 'ƒêƒÉng'; btn.disabled = false; } },
        handleImg: (inp) => { if(inp.files[0]) { const r = new FileReader(); r.onload = e => { document.getElementById('img-preview').src = e.target.result; document.getElementById('preview-area').classList.remove('hidden'); }; r.readAsDataURL(inp.files[0]); } },
        clearImg: () => { document.getElementById('file-input').value = ''; document.getElementById('preview-area').classList.add('hidden'); },
        like: async (tab, id, liked) => { if (liked) return; const btn = document.querySelector(`button[onclick="window.app.like('${tab}', '${id}', ${liked})"]`); if(btn) { btn.classList.remove('text-gray-400', 'text-gray-500'); btn.classList.add('text-red-500', 'font-bold'); btn.disabled = true; const countSpan = btn.querySelector('span'); if(countSpan) { let currentCount = parseInt(countSpan.textContent) || 0; countSpan.textContent = currentCount + 1; } } const ref = doc(db, `artifacts/${appId}/posts_${tab}`, id); try { await updateDoc(ref, { likes: arrayUnion(currentUser.id) }); await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { coins: increment(5) }); } catch(e) { console.error("L·ªói like:", e); if(btn) btn.classList.remove('text-red-500'); } },
        cmtBtn: async (tab, id) => { const inputEl = document.getElementById(`cmt-${id}`); const val = inputEl ? inputEl.value.trim() : ''; if(val) { try { await updateDoc(doc(db, `artifacts/${appId}/posts_${tab}`, id), { comments: arrayUnion({ user: currentUser.name, uid: currentUser.id, text: val, time: new Date().toISOString() }) }); await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { coins: increment(5) }); inputEl.value = ''; } catch (e) { alert("L·ªói g·ª≠i comment: " + e.message); } } else { alert("B·∫°n ch∆∞a nh·∫≠p n·ªôi dung!"); } },
        delPost: (tab, id) => { if(confirm("X√≥a b√†i n√†y?")) { deleteDoc(doc(db, `artifacts/${appId}/posts_${tab}`, id)); } },
        uploadBanner: async (file) => { if(!file) return; try { const compressed = await compressImage(file, 1280, 0.8); const sRef = storageRef(getStorage(), `artifacts/${appId}/banner/main`); const snap = await uploadBytes(sRef, compressed); const url = await getDownloadURL(snap.ref); await setDoc(APP_CONFIG_DOC(db), { [BANNER_KEY]: url }, { merge: true }); alert("Banner ƒë√£ c·∫≠p nh·∫≠t!"); } catch(e) { alert("L·ªói: " + e.message); } },
        loadBanner: () => { if(!db) return; onSnapshot(APP_CONFIG_DOC(db), d => { const url = d.exists() ? d.data()[BANNER_KEY] : null; const img = document.getElementById('main-banner'); const placeholder = document.getElementById('banner-placeholder'); const loginImg = document.getElementById('login-banner-img'); if(url) { img.src = url; img.classList.remove('hidden'); placeholder.classList.add('hidden'); if(loginImg) { loginImg.src = url; loginImg.classList.remove('hidden'); } } else { img.classList.add('hidden'); placeholder.classList.remove('hidden'); } document.getElementById('banner-controls').classList.toggle('hidden', currentUser?.role !== 'admin'); }); },
        updateAvatar: async (file) => { if(!file) return; try { const timestamp = Date.now(); const compressed = await compressImage(file, 200, 0.7); const sRef = storageRef(getStorage(), `artifacts/${appId}/avatars/${currentUser.id}_${timestamp}`); const snap = await uploadBytes(sRef, compressed); const url = await getDownloadURL(snap.ref); await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { avatarUrl: url }); currentUser.avatarUrl = url; localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(currentUser)); document.getElementById('avatar-preview').src = url; alert("ƒê√£ ƒë·ªïi Avatar th√†nh c√¥ng!"); } catch(e) { alert("L·ªói: " + e.message); } },
        changePassword: async () => { const p1 = document.getElementById('new-password').value; const p2 = document.getElementById('confirm-password').value; if(p1.length < 6 || p1!==p2) return alert("M·∫≠t kh·∫©u kh√¥ng kh·ªõp ho·∫∑c qu√° ng·∫Øn"); try { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { password: p1 }); alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng"); } catch(e) { alert("L·ªói: " + e.message); } },
        
        loadUsers: () => { getDocs(collection(db, `artifacts/${appId}/users`)).then(snap => { document.getElementById('user-list').innerHTML = snap.docs.map(d => { const u = d.data(); return `<div class="flex justify-between items-center p-3 bg-gray-50 rounded border mb-2"><div><b>${u.name}</b> <span class="text-xs text-gray-500">(${u.username}) - ${u.points||0} xu</span></div><button onclick="window.app.delUser('${d.id}')" class="text-red-500"><i data-lucide="trash-2" width="16"></i></button></div>`; }).join(''); lucide.createIcons(); }); },
        createUser: async () => { const u = document.getElementById('new-u').value; const p = document.getElementById('new-p').value; const n = document.getElementById('new-n').value; const d = document.getElementById('new-d').value; if(!u || !p || !n) return alert("Thi·∫øu th√¥ng tin!"); await addDoc(collection(db, `artifacts/${appId}/users`), { username: u, password: p, name: n, dob: d, role: 'student', avatarUrl: '', points: 0, inventory: [] }); alert("ƒê√£ t·∫°o!"); document.getElementById('new-u').value = ''; document.getElementById('new-p').value = ''; document.getElementById('new-n').value = ''; document.getElementById('new-d').value = ''; },
        delUser: async (id) => { if(confirm("X√≥a?")) { await deleteDoc(doc(db, `artifacts/${appId}/users`, id)); window.app.loadUsers(); } },
        bulkCreateUsers: async () => { const fileInput = document.getElementById('bulk-user-file'); const file = fileInput.files[0]; const statusEl = document.getElementById('bulk-status'); const btn = document.getElementById('btn-bulk-create'); if (!file) { statusEl.textContent = "Ch·ªçn file!"; statusEl.classList.remove('hidden'); return; } btn.textContent = 'ƒêang x·ª≠ l√Ω...'; btn.disabled = true; statusEl.classList.add('hidden'); try { const content = await file.text(); const lines = content.trim().split(/\r?\n/).filter(line => line.trim() !== ''); let successCount = 0; for (const line of lines) { const parts = line.split(',').map(p => p.trim()); if (parts.length >= 2) { const fullName = parts[0]; const dob = parts[1]; const username = removeDiacritics(fullName).toLowerCase().replace(/\s/g, ''); const q = query(collection(db, `artifacts/${appId}/users`), where('username', '==', username)); const existing = await getDocs(q); if (existing.empty) { await addDoc(collection(db, `artifacts/${appId}/users`), { username, password: '123', name: fullName, dob, role: 'student', avatarUrl: '', points: 0, inventory: [] }); successCount++; } } } statusEl.textContent = `Th√†nh c√¥ng: ${successCount} TK.`; statusEl.classList.remove('hidden', 'text-red-500'); statusEl.classList.add('text-green-600'); } catch(e) { statusEl.textContent = "L·ªói: " + e.message; statusEl.classList.add('text-red-500'); statusEl.classList.remove('hidden'); } finally { btn.textContent = 'Th·ª±c Hi·ªán T·∫°o'; btn.disabled = false; window.app.loadUsers(); } },
        
        loadBday: () => { const el = document.getElementById('feed'); const today = new Date(); const cm = today.getMonth() + 1; unsubscribeFeed = onSnapshot(collection(db, `artifacts/${appId}/users`), snap => { el.innerHTML = ''; let list = [], todayUser = null; snap.forEach(d => { const u = d.data(); if(u.dob) { const date = new Date(u.dob); if(date.getMonth() + 1 === cm) { list.push({...u, id:d.id, day: date.getDate()}); if(date.getDate() === today.getDate()) todayUser = {...u, id:d.id}; } } }); if(todayUser) { el.innerHTML += `<div class="bg-gradient-to-r from-pink-100 to-rose-100 p-4 rounded-2xl shadow border-2 border-pink-200 mb-6 text-center"><h3 class="font-bold text-pink-700 text-lg animate-bounce">üéÇ CH√öC M·ª™NG SINH NH·∫¨T! üéÇ</h3><img src="${todayUser.avatarUrl || 'https://via.placeholder.com/80?text=HPBD'}" class="w-20 h-20 rounded-full mx-auto my-3 border-4 border-white shadow"><p class="font-bold text-xl text-slate-800">${todayUser.name}</p><p class="text-pink-600">H√¥m nay l√† ng√†y ƒë·∫∑c bi·ªát c·ªßa b·∫°n ·∫•y!</p><div class="mt-4 text-left bg-white p-3 rounded-xl"><p class="font-bold text-xs mb-2">G·ª≠i l·ªùi ch√∫c:</p><div class="flex gap-2"><input id="i-bday" class="flex-1 border p-2 rounded-lg text-sm" placeholder="Ch√∫c m·ª´ng sinh nh·∫≠t..."><button onclick="window.app.cmtBdayBtn('${todayUser.id}')" class="bg-pink-500 text-white px-3 rounded-lg font-bold">G·ª≠i</button></div><div id="comments-bday" class="mt-2 space-y-1">Loading l·ªùi ch√∫c...</div></div></div>`; window.app.loadBdayComments(todayUser.id); document.getElementById('post-form').classList.add('hidden'); } if(list.length > 0) { el.innerHTML += `<h3 class="font-bold text-slate-700 mb-3 bg-white inline-block px-3 py-1 rounded-lg">Danh S√°ch Sinh Nh·∫≠t Th√°ng ${cm}</h3>`; list.sort((a,b) => a.day - b.day); el.innerHTML += list.map(u => `<div class="flex items-center bg-white p-3 rounded-xl shadow-sm border mb-2"><i data-lucide="cake" class="text-pink-500 mr-3"></i><div class="flex-1 font-bold text-gray-700">${u.name}</div><span class="bg-pink-100 text-pink-700 px-2 py-1 rounded text-xs font-bold">Ng√†y ${u.day}</span></div>`).join(''); } else { el.innerHTML += `<div class="text-center text-gray-400">Th√°ng n√†y kh√¥ng c√≥ sinh nh·∫≠t n√†o.</div>`; } lucide.createIcons(); }); },
        loadBdayComments: (uid) => { onSnapshot(query(collection(db, `artifacts/${appId}/users/${uid}/wishes`), orderBy('time','asc')), snap => { const cEl = document.getElementById('comments-bday'); if(cEl) cEl.innerHTML = snap.empty ? '<i class="text-xs text-gray-400">Ch∆∞a c√≥ l·ªùi ch√∫c n√†o.</i>' : snap.docs.map(d=> `<div class="text-xs bg-gray-50 p-1 rounded"><b>${d.data().user}:</b> ${d.data().text}</div>`).join(''); }); },
        cmtBdayBtn: (uid) => { const val = document.getElementById('i-bday').value.trim(); if(val) { addDoc(collection(db, `artifacts/${appId}/users/${uid}/wishes`), { user: currentUser.name, text: val, time: new Date().toISOString() }); document.getElementById('i-bday').value = ''; } },
        
        loadStudentsForReward: async () => { const selectEl = document.getElementById('reward-student-select'); selectEl.innerHTML = '<option value="">-- Ch·ªçn h·ªçc sinh --</option>'; try { const snap = await getDocs(collection(db, `artifacts/${appId}/users`)); snap.forEach(doc => { const u = doc.data(); if(u.role !== 'admin') { const name = u.name || u.fullName || u.username; selectEl.innerHTML += `<option value="${doc.id}">${name} (Xu: ${u.coins||0})</option>`; } }); } catch(e) {} },
        loadStudentsForSelection: async () => { const s = await getDocs(collection(db, `artifacts/${appId}/users`)); document.getElementById('star-student-list').innerHTML = s.docs.map(d=>`<label class="student-select-item"><input type="checkbox" value="${d.id}" class="w-5 h-5 accent-yellow-500 shrink-0"><span class="ml-2">${d.data().name}</span></label>`).join(''); },
        postStarBoard: async () => { const t=document.getElementById('star-title').value; if(!t) return; const sel = Array.from(document.querySelectorAll('#star-student-list input:checked')).map(i=> { const u=window.app.userCache[i.value]; return {id:i.value, name:u.name, avatarUrl:u.avatarUrl}; }); await addDoc(collection(db, `artifacts/${appId}/posts_stars`), { type:'star_board', content:t, students:sel, author:currentUser.name, uid:currentUser.id, date:new Date().toISOString() }); alert("ƒê√£ ƒëƒÉng"); },
        adminGiveCoins: async () => { const uid = document.getElementById('reward-student-select').value; const amount = parseInt(document.getElementById('reward-amount').value); const reason = document.getElementById('reward-reason').value; if (!uid) return alert("Vui l√≤ng ch·ªçn h·ªçc sinh!"); if (!amount || amount <= 0) return alert("S·ªë xu ph·∫£i l·ªõn h∆°n 0!"); try { await updateDoc(doc(db, `artifacts/${appId}/users`, uid), { coins: increment(amount) }); await addDoc(collection(db, `artifacts/${appId}/posts_notif`), { content: `üéÅ C√¥ gi√°o t·∫∑ng ${amount} Xu. L√Ω do: ${reason}`, author: currentUser.name, uid: 'admin', date: new Date().toISOString(), likes: [], comments: [], targetUser: uid }); alert(`ƒê√£ t·∫∑ng ${amount} Xu th√†nh c√¥ng!`); document.getElementById('reward-amount').value = ''; document.getElementById('reward-reason').value = ''; window.app.loadStudentsForReward(); } catch(e) { console.error(e); alert("L·ªói: " + e.message); } },
        
        buyItem: async (id, price) => { if((currentUser.coins||0) < price) return alert("Thi·∫øu xu!"); if((currentUser.inventory||[]).includes(id)) return alert("ƒê√£ c√≥!"); if(confirm("Mua?")) try { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { coins: increment(-price), inventory: arrayUnion(id) }); alert("ƒê√£ mua!"); } catch(e){ alert(e.message); } },
        renderInventory: () => { const list = document.getElementById('inventory-list'), inv = currentUser.inventory||[]; list.innerHTML = inv.length ? inv.map(i => `<div class="p-2 border rounded flex justify-between items-center"><span>${i==='frame_gold'?'Khung V√†ng':'Khung B·∫°c'}</span>${currentUser.frame===i ? '<span class="text-green-600 font-bold text-xs">ƒêang d√πng</span>' : `<button onclick="app.equipFrame('${i}')" class="text-blue-500 font-bold text-xs">D√πng</button>`}</div>`).join('') : '<p class="text-gray-400">Tr·ªëng</p>'; },
        equipFrame: async (id) => { try { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { frame: id }); alert("ƒê√£ thay khung!"); } catch(e){} },
        updateOnlineStatus: () => { const now = Date.now(), users = []; for(const id in window.app.userCache) { const u = window.app.userCache[id]; if(u.lastActive && now - u.lastActive < 60000) users.push(u.name); } const el = document.getElementById('online-users-container'); if(users.length) { el.classList.remove('hidden'); document.getElementById('online-users-list').textContent = users.join(', '); } else el.classList.add('hidden'); },
        reportOnline: async () => { if(currentUser?.id) try { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { lastActive: Date.now() }); } catch(e) {} },
        checkNotifications: async () => { const lastCheck = localStorage.getItem('last_notif_check') || '2000-01-01'; newNotifs = []; const collections = ['posts_diary', 'posts_pets', 'posts_chat', 'posts_notif', 'posts_stars', 'posts_bday']; const titles = {'posts_diary': 'Nh·∫≠t K√Ω', 'posts_pets': 'Th√∫ C∆∞ng', 'posts_chat': 'H·ªèi ƒê√°p', 'posts_notif': 'Th√¥ng B√°o', 'posts_stars': 'Vinh Danh', 'posts_bday': 'Sinh Nh·∫≠t'}; const navKeys = {'posts_diary': 'diary', 'posts_pets': 'pets', 'posts_chat': 'chat', 'posts_notif': 'notif', 'posts_stars': 'stars', 'posts_bday': 'bday'}; try { for(const col of collections) { const q = query(collection(db, `artifacts/${appId}/${col}`), orderBy('date', 'desc'), limit(5)); const snap = await getDocs(q); snap.forEach(doc => { const d = doc.data(); if(d.date > lastCheck) { newNotifs.push({ id: doc.id, title: titles[col], content: d.content || d.text || 'B√†i vi·∫øt m·ªõi', author: d.author || 'H·ªá th·ªëng', tab: navKeys[col], date: d.date }); } }); } newNotifs.sort((a,b) => new Date(b.date) - new Date(a.date)); window.app.renderNotifUI(); } catch(e) { console.error("L·ªói check notif", e); } },
        renderNotifUI: () => { const count = newNotifs.length; const badges = [document.getElementById('dash-notif-badge'), document.getElementById('detail-notif-badge')]; const lists = [document.getElementById('dash-notif-list'), document.getElementById('detail-notif-list')]; badges.forEach(b => { if(b) { b.textContent = count > 9 ? '9+' : count; if(count > 0) b.classList.remove('hidden'); else b.classList.add('hidden'); } }); const html = count === 0 ? '<div class="p-3 text-sm font-bold text-gray-500 text-center">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>' : newNotifs.map(n => `<div class="notif-item" onclick="app.handleNotifClick('${n.tab}')"><div class="notif-badge-icon"><i data-lucide="zap" width="16"></i></div><div class="flex-1 overflow-hidden"><div class="text-xs font-bold text-indigo-600 uppercase">${n.title}</div><div class="text-sm font-bold text-slate-700 truncate">${n.author}: ${n.content}</div><div class="text-[10px] text-gray-400">${new Date(n.date).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}</div></div></div>`).join(''); lists.forEach(l => { if(l) { l.innerHTML = html; lucide.createIcons(); } }); },
        toggleNotif: (view = 'dash') => { const list = document.getElementById(view === 'detail' ? 'detail-notif-list' : 'dash-notif-list'); const isHidden = list.style.display === 'none' || list.style.display === ''; document.querySelectorAll('.notif-dropdown').forEach(el => el.style.display = 'none'); if(isHidden) { list.style.display = 'block'; localStorage.setItem('last_notif_check', new Date().toISOString()); document.getElementById('dash-notif-badge').classList.add('hidden'); document.getElementById('detail-notif-badge').classList.add('hidden'); } },
        handleNotifClick: (tab) => { window.app.nav(tab); document.querySelectorAll('.notif-dropdown').forEach(el => el.style.display = 'none'); },
        
        checkDailyBirthday: async () => { const today = new Date(); const dateKey = `seen_bday_${today.getFullYear()}_${today.getMonth()}_${today.getDate()}`; if (localStorage.getItem(dateKey)) return; try { const snap = await getDocs(collection(db, `artifacts/${appId}/users`)); let bdayNames = []; snap.forEach(d => { const u = d.data(); if (u.dob) { const dob = new Date(u.dob); if (dob.getDate() === today.getDate() && dob.getMonth() === today.getMonth()) { bdayNames.push(u.name); } } }); if (bdayNames.length > 0) { const modal = document.getElementById('birthday-modal'); const nameEl = document.getElementById('bday-names'); if(modal && nameEl) { nameEl.textContent = bdayNames.join(", "); modal.classList.remove('hidden'); var duration = 5 * 1000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 200 }; var interval = setInterval(function() { var timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) { return clearInterval(interval); } var particleCount = 50 * (timeLeft / duration); confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random()*0.2, y: Math.random() - 0.2 } })); confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random()*0.2 + 0.8, y: Math.random() - 0.2 } })); }, 250); localStorage.setItem(dateKey, 'true'); } } } catch (e) { console.error("L·ªói check sinh nh·∫≠t:", e); } },
        checkCheckInStatus: () => { const btn = document.getElementById('btn-checkin'); if (!btn) return; const today = new Date().toDateString(); if (currentUser.lastCheckIn === today) { btn.disabled = true; btn.className = "bg-gray-300 text-gray-500 px-3 py-2 rounded-xl font-bold flex items-center gap-1 text-sm cursor-default border border-gray-200"; btn.innerHTML = '<i data-lucide="check" width="16"></i> <span>ƒê√£ ƒëi·ªÉm danh</span>'; lucide.createIcons(); } },
        dailyCheckIn: async () => { const today = new Date().toDateString(); if (currentUser.lastCheckIn === today) return; const btn = document.getElementById('btn-checkin'); btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> X·ª≠ l√Ω...'; try { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { coins: increment(10), lastCheckIn: today }); currentUser.coins = (currentUser.coins || 0) + 10; currentUser.lastCheckIn = today; document.getElementById('current-coins').textContent = currentUser.coins; window.app.checkCheckInStatus(); alert("üéâ ƒêi·ªÉm danh th√†nh c√¥ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c 10 Xu."); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); } catch(e) { console.error(e); alert("L·ªói: " + e.message); btn.innerHTML = '<i data-lucide="calendar-check" width="16"></i> <span>ƒêi·ªÉm Danh</span>'; lucide.createIcons(); } },
        
        initQuiz: async () => { try { const qSnap = await getDoc(QUIZ_DATA_DOC(db)); if(qSnap.exists()) { activeQuestions = qSnap.data().list || []; } else { activeQuestions = [{ q: "Con g√¨ t√°m c·∫≥ng hai c√†ng?", options: ["Con cua", "Con g√†", "Con ch√≥", "Con m√®o"], a: 0 }]; } } catch(e) { console.error(e); } if(quizStatusListener) quizStatusListener(); quizStatusListener = onSnapshot(QUIZ_GLOBAL_DOC(db), (docSnap) => { const status = docSnap.exists() ? docSnap.data().status : 'waiting'; window.app.renderQuizUI(status); }); if(currentUser.role === 'admin') { if(quizLiveScoreListener) quizLiveScoreListener(); quizLiveScoreListener = onSnapshot(collection(db, `artifacts/${appId}/quiz_results`), (snap) => { const list = []; snap.forEach(d => list.push(d.data())); list.sort((a,b) => b.score - a.score); const html = list.map(u => `<div class="flex justify-between border-b p-1"><span>${u.name}</span><span class="font-bold text-purple-600">${u.score}</span></div>`).join(''); document.getElementById('quiz-live-score').innerHTML = html || 'Ch∆∞a c√≥ d·ªØ li·ªáu'; if(document.getElementById('quiz-result').classList.contains('hidden') === false) { const top5 = list.slice(0,5).map((u,i) => `<div class="flex items-center gap-2"><span class="font-bold text-yellow-600">#${i+1}</span> <img src="${window.app.userCache[u.uid]?.avatarUrl || 'https://via.placeholder.com/20'}" class="w-6 h-6 rounded-full"> <span>${u.name}</span> <span class="ml-auto font-bold">${u.score}ƒë</span></div>`).join(''); document.getElementById('quiz-top5-list').innerHTML = top5; document.getElementById('quiz-top5').classList.remove('hidden'); } }); } },
        openQuizEditor: () => { const container = document.getElementById('editor-questions-list'); container.innerHTML = ''; activeQuestions.forEach((q, idx) => { container.appendChild(window.app.createEditorItem(idx, q)); }); document.getElementById('quiz-editor').classList.remove('hidden'); },
        createEditorItem: (idx, data = { q: '', options: ['', '', '', ''], a: 0 }) => { const div = document.createElement('div'); div.className = "bg-white p-4 rounded-xl shadow border border-gray-200"; div.innerHTML = `<div class="flex justify-between mb-2"><span class="font-bold text-purple-700">C√¢u ${idx + 1}</span><button onclick="this.parentElement.parentElement.remove()" class="text-red-500 text-xs font-bold">X√≥a</button></div><input class="w-full p-2 border rounded mb-2 font-bold" placeholder="Nh·∫≠p c√¢u h·ªèi..." value="${data.q}"><div class="grid grid-cols-1 gap-2">${[0,1,2,3].map(i => `<div class="flex items-center gap-2"><input type="radio" name="correct_${idx}" ${data.a === i ? 'checked' : ''} class="w-4 h-4 accent-green-600"><input class="flex-1 p-2 border rounded text-sm" placeholder="ƒê√°p √°n ${i+1}" value="${data.options[i]}"></div>`).join('')}</div>`; return div; },
        addEditorQuestion: () => { const container = document.getElementById('editor-questions-list'); const idx = container.children.length; container.appendChild(window.app.createEditorItem(idx)); },
        saveQuizQuestions: async () => { const container = document.getElementById('editor-questions-list'); const newQuestions = []; for(let i = 0; i < container.children.length; i++) { const item = container.children[i]; const qText = item.querySelector('input[placeholder="Nh·∫≠p c√¢u h·ªèi..."]').value.trim(); if(!qText) continue; const optInputs = item.querySelectorAll('input[placeholder^="ƒê√°p √°n"]'); const correctRadio = item.querySelectorAll('input[type="radio"]'); const options = []; let correctIdx = 0; optInputs.forEach((inp, idx) => { options.push(inp.value.trim()); if(correctRadio[idx].checked) correctIdx = idx; }); newQuestions.push({ q: qText, options: options, a: correctIdx }); } if(newQuestions.length === 0) return alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 c√¢u h·ªèi!"); try { await setDoc(QUIZ_DATA_DOC(db), { list: newQuestions }); activeQuestions = newQuestions; document.getElementById('quiz-editor').classList.add('hidden'); alert("ƒê√£ l∆∞u b·ªô c√¢u h·ªèi th√†nh c√¥ng!"); } catch(e) { alert("L·ªói l∆∞u: " + e.message); } },
        deleteAllQuestions: async () => { if(confirm("C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ c√¢u h·ªèi trong b·ªô ƒë·ªÅ kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) { try { await setDoc(QUIZ_DATA_DOC(db), { list: [] }); activeQuestions = []; window.app.openQuizEditor(); alert("ƒê√£ x√≥a s·∫°ch to√†n b·ªô c√¢u h·ªèi!"); } catch(e) { alert("L·ªói khi x√≥a: " + e.message); } } },
        renderQuizUI: async (status) => { const waitingEl = document.getElementById('quiz-waiting'); const playingEl = document.getElementById('quiz-playing'); const resultEl = document.getElementById('quiz-result'); const adminEl = document.getElementById('quiz-admin-controls'); waitingEl.classList.add('hidden'); playingEl.classList.add('hidden'); resultEl.classList.add('hidden'); if(currentUser.role === 'admin') { adminEl.classList.remove('hidden'); return; } if(status === 'waiting') { waitingEl.classList.remove('hidden'); currentScore = 0; currentQIndex = 0; } else if (status === 'active') { if(activeQuestions.length === 0) { alert("Ch∆∞a c√≥ c√¢u h·ªèi!"); return; } const myProgRef = doc(db, `artifacts/${appId}/quiz_results`, currentUser.id); const myProgSnap = await getDoc(myProgRef); if(myProgSnap.exists()) { const data = myProgSnap.data(); currentQIndex = data.currentQuestion || 0; currentScore = data.score || 0; } else { currentQIndex = 0; currentScore = 0; } if(currentQIndex >= activeQuestions.length) { document.getElementById('final-score').textContent = currentScore; document.getElementById('earned-coins').textContent = currentScore; resultEl.classList.remove('hidden'); } else { playingEl.classList.remove('hidden'); window.app.renderQuestion(); } } else if (status === 'finished') { const myProgRef = doc(db, `artifacts/${appId}/quiz_results`, currentUser.id); const myProgSnap = await getDoc(myProgRef); const finalS = myProgSnap.exists() ? myProgSnap.data().score : currentScore; document.getElementById('final-score').textContent = finalS; document.getElementById('earned-coins').textContent = finalS; resultEl.classList.remove('hidden'); } },
        renderQuestion: () => { if(currentQIndex >= activeQuestions.length) { window.app.finishQuizAttempt(); return; } const q = activeQuestions[currentQIndex]; document.getElementById('q-idx').textContent = currentQIndex + 1; document.getElementById('q-total').textContent = activeQuestions.length; document.getElementById('q-score-disp').textContent = currentScore + ' ƒëi·ªÉm'; document.getElementById('q-text').textContent = q.q; document.getElementById('btn-next-q').classList.add('hidden'); const optsDiv = document.getElementById('q-options'); optsDiv.innerHTML = q.options.map((opt, idx) => `<div id="opt-${idx}" onclick="app.answerQuiz(${idx})" class="quiz-option">${opt}</div>`).join(''); clearInterval(quizTimer); quizTimeLeft = 20; const barFill = document.getElementById('timer-bar-fill'); const timerText = document.getElementById('timer-text'); barFill.style.width = '100%'; barFill.style.background = '#22c55e'; timerText.textContent = quizTimeLeft + 's'; quizTimer = setInterval(() => { quizTimeLeft--; const pct = (quizTimeLeft / 20) * 100; barFill.style.width = pct + '%'; if(pct < 30) barFill.style.background = '#ef4444'; timerText.textContent = quizTimeLeft + 's'; if(quizTimeLeft <= 0) { clearInterval(quizTimer); app.answerQuiz(-1); } }, 1000); },
        answerQuiz: async (choiceIdx) => { clearInterval(quizTimer); const q = activeQuestions[currentQIndex]; let pointsEarned = 0; const optionsDivs = document.querySelectorAll('.quiz-option'); optionsDivs.forEach(div => div.classList.add('pointer-events-none')); if (choiceIdx !== -1) { const selectedDiv = document.getElementById(`opt-${choiceIdx}`); if(choiceIdx === q.a) { selectedDiv.classList.add('quiz-correct'); const timeTaken = 20 - quizTimeLeft; if(timeTaken <= 10) pointsEarned = 10; else pointsEarned = Math.max(0, 10 - (timeTaken - 10)); } else { selectedDiv.classList.add('quiz-wrong'); document.getElementById(`opt-${q.a}`).classList.add('quiz-correct'); } } else { document.getElementById(`opt-${q.a}`).classList.add('quiz-correct'); } currentScore += pointsEarned; await setDoc(doc(db, `artifacts/${appId}/quiz_results`, currentUser.id), { uid: currentUser.id, name: currentUser.name, score: currentScore, currentQuestion: currentQIndex }, { merge: true }); if(pointsEarned > 0) { await updateDoc(doc(db, `artifacts/${appId}/users`, currentUser.id), { coins: increment(pointsEarned) }); } document.getElementById('btn-next-q').classList.remove('hidden'); },
        nextQuestion: async () => { currentQIndex++; await setDoc(doc(db, `artifacts/${appId}/quiz_results`, currentUser.id), { currentQuestion: currentQIndex }, { merge: true }); if(currentQIndex < activeQuestions.length) window.app.renderQuestion(); else window.app.finishQuizAttempt(); },
        finishQuizAttempt: () => { document.getElementById('quiz-playing').classList.add('hidden'); document.getElementById('quiz-result').classList.remove('hidden'); document.getElementById('final-score').textContent = currentScore; document.getElementById('earned-coins').textContent = currentScore; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); },
        quizAdmin: async (action) => { if(action === 'prepare') { if(confirm("H√†nh ƒë·ªông n√†y s·∫Ω X√ìA S·∫†CH ƒëi·ªÉm v√† l·ªãch s·ª≠ l√†m b√†i c·ªßa t·∫•t c·∫£ h·ªçc sinh ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·ª£t thi m·ªõi. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) { try { await setDoc(QUIZ_GLOBAL_DOC(db), { status: 'waiting' }); const q = query(collection(db, `artifacts/${appId}/quiz_results`)); const snapshot = await getDocs(q); const batch = writeBatch(db); snapshot.docs.forEach((doc) => { batch.delete(doc.ref); }); await batch.commit(); alert("ƒê√£ reset to√†n b·ªô ƒëi·ªÉm. S·∫µn s√†ng cho ƒë·ª£t thi m·ªõi!"); } catch(e) { alert("L·ªói khi reset: " + e.message); } } } else if (action === 'start') { await setDoc(QUIZ_GLOBAL_DOC(db), { status: 'active' }); } else if (action === 'stop') { await setDoc(QUIZ_GLOBAL_DOC(db), { status: 'finished' }); } },
// --- T√çNH NƒÇNG TR√í CHUY·ªÜN V·ªöI TH√ö C∆ØNG (AI) ---
        
        // --- B·∫ÆT ƒê·∫¶U CODE AI M·ªöI ---
        startListening: () => {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Speech) { alert("M√°y n√†y kh√¥ng h·ªó tr·ª£ Micro. H√£y g√µ ph√≠m!"); return; }
            const rec = new Speech();
            rec.lang = 'vi-VN';
            document.getElementById('btn-mic').classList.add('bg-red-500', 'animate-pulse');
            rec.start();
            rec.onresult = (e) => { 
                const t = e.results[0][0].transcript; 
                document.getElementById('pet-input-text').value = t; 
                window.app.processPetResponse(t); 
            };
            rec.onend = () => document.getElementById('btn-mic').classList.remove('bg-red-500', 'animate-pulse');
            rec.onerror = (e) => { 
                if(e.error !== 'no-speech') console.log("L·ªói Micro:", e.error);
                document.getElementById('btn-mic').classList.remove('bg-red-500');
            };
        },

        sendPetText: () => {
            const t = document.getElementById('pet-input-text').value;
            if(t) {
                document.getElementById('pet-input-text').value = '';
                window.app.processPetResponse(t);
            }
        },

      processPetResponse: async (text) => {
            const bubble = document.getElementById('pet-chat-bubble');
            const chatText = document.getElementById('pet-chat-text');
            bubble.classList.remove('hidden');
            
            // Hi·ªáu ·ª©ng "ƒêang nghƒ©" vui nh·ªôn
            const thinkingIcons = ["ü§î", "‚ö°", "üí°", "g√¢u...", "meow..."];
            const randIcon = thinkingIcons[Math.floor(Math.random() * thinkingIcons.length)];
            chatText.textContent = `ƒêang nghƒ©... ${randIcon}`;

            // B∆Ø·ªöC 1: L·∫§Y API KEY (Ch·ªâ l·∫•y 1 l·∫ßn ƒë·∫ßu ti√™n, c√°c l·∫ßn sau d√πng l·∫°i ngay l·∫≠p t·ª©c)
            if (!_cachedGeminiKey) {
                try {
                    // L·∫•y Key t·ª´ Firestore
                    const keySnap = await firebase.firestore().collection("artifacts").doc("system_config").get();
                    if (keySnap.exists && keySnap.data().gemini) {
                        _cachedGeminiKey = keySnap.data().gemini;
                    } else {
                        throw new Error("Ch∆∞a c·∫•u h√¨nh Key trong h·ªá th·ªëng (artifacts/system_config).");
                    }
                } catch (e) {
                    console.error("L·ªói l·∫•y Key:", e);
                    // N·∫øu l·ªói l·∫•y Key, th·ª≠ d√πng Key m·∫∑c ƒë·ªãnh trong file (n·∫øu c√≥) ho·∫∑c b√°o l·ªói
                    chatText.textContent = "L·ªói k·∫øt n·ªëi h·ªá th·ªëng. Th·ª≠ l·∫°i sau nh√©!";
                    setTimeout(() => bubble.classList.add('hidden'), 5000);
                    return;
                }
            }

            try {
                // B∆Ø·ªöC 2: G·ªåI TR·ª∞C TI·∫æP MODEL FLASH (B·ªè qua b∆∞·ªõc ListModels ƒë·ªÉ ch·∫°y si√™u t·ªëc)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${_cachedGeminiKey}`;
                
                // T·∫°o c√¢u nh·∫Øc (Prompt) ng·∫Øn g·ªçn, ph√π h·ª£p v·ªõi th√∫ c∆∞ng
                const prompt = `ƒê√≥ng vai th√∫ c∆∞ng t√™n "${currentUser?.pet?.name || 'B√© c∆∞ng'}" c·ªßa "${currentUser?.name || 'b·∫°n nh·ªè'}". Tr·∫£ l·ªùi c·ª±c ng·∫Øn (d∆∞·ªõi 15 t·ª´), d·ªÖ th∆∞∆°ng, h√†i h∆∞·ªõc. C√¢u h·ªèi: ${text}`;

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!res.ok) {
                    // N·∫øu Flash l·ªói, th·ª≠ fallback sang Pro (D·ª± ph√≤ng)
                    console.warn("Flash l·ªói, th·ª≠ sang Pro...");
                    const urlPro = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${_cachedGeminiKey}`;
                    const resPro = await fetch(urlPro, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if(!resPro.ok) throw new Error("Th√∫ c∆∞ng ƒëang ng·ªß (M·∫•t k·∫øt n·ªëi)");
                    var data = await resPro.json();
                } else {
                    var data = await res.json();
                }
                
                // L·∫•y n·ªôi dung tr·∫£ l·ªùi an to√†n
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "G√¢u g√¢u? (Em kh√¥ng hi·ªÉu)";
                
                // Hi·ªÉn th·ªã v√† ƒë·ªçc
                chatText.textContent = reply;
                window.app.speak(reply);
                
                // Hi·ªáu ·ª©ng nh·∫£y
                if(window.app.animatePetClick) window.app.animatePetClick();
                setTimeout(() => bubble.classList.add('hidden'), 6000);

            } catch(e) {
                console.error("L·ªói AI:", e);
                chatText.textContent = "Hic, m·∫°ng lag qu√° ·∫°! üåê";
                setTimeout(() => bubble.classList.add('hidden'), 5000);
            return;
        }
    }
    GEMINI_API_KEY = _cachedGeminiKey;

    try {
        // B∆Ø·ªöC 1 & 2: GI·ªÆ NGUY√äN LOGIC C≈® C·ª¶A B·∫†N (L·∫•y danh s√°ch v√† ch·ªçn model t·ªët nh·∫•t)
        const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`;
        const listRes = await fetch(listUrl);
        const listData = await listRes.json();
        
        if (listData.error) throw new Error("L·ªói l·∫•y danh s√°ch: " + listData.error.message);

        let model = listData.models.find(m => m.name.includes('gemini-1.5-flash'));
        if (!model) model = listData.models.find(m => m.name.includes('gemini-pro'));
        if (!model) model = listData.models.find(m => m.name.includes('gemini'));
        
        if (!model) throw new Error("Kh√¥ng t√¨m th·∫•y model n√†o kh·∫£ d·ª•ng!");

        const modelName = model.name.replace('models/', '');
        
        // B∆Ø·ªöC 3: G·ª¨I TIN NH·∫ÆN
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;
        
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ 
                // T·ªëi ∆∞u h√≥a l·∫°i Prompt:
                text: `B·∫°n l√† m·ªôt ch√∫ ${currentUser?.pet?.type || 'th√∫ c∆∞ng'} ƒë√°ng y√™u t√™n l√† "${currentUser?.pet?.name || 'B√© c∆∞ng'}". 
                                Ch·ªß nh√¢n c·ªßa b·∫°n l√† "${currentUser?.name || 'b·∫°n nh·ªè'}". 
                                Nhi·ªám v·ª•:
                                1. thi tho·∫£ng ch√†o v√† g·ªçi t√™n "${currentUser?.name || 'ch·ªß nh√¢n'}" trong c√¢u tr·∫£ l·ªùi.
                                2. N·∫øu ƒë∆∞·ª£c h·ªèi v·ªÅ To√°n, VƒÉn ho·∫∑c Ti·∫øng Anh, h√£y ƒë√≥ng vai m·ªôt gia s∆∞ nh√≠ gi·∫£i th√≠ch th·∫≠t d·ªÖ hi·ªÉu, ƒë∆∞a ra v√≠ d·ª• v√† khen ng·ª£i ch·ªß nh√¢n.
                                4.TUY·ªÜT ƒê·ªêI KH√îNG ƒê·ªåC ICON, EMOJI HAY K√ù T·ª∞ ƒê·∫∂C BI·ªÜT. CH·ªà D√ôNG L·ªúI N√ìI C√ì TRONG VƒÇN B·∫¢N TR·∫¢ L·ªúI.
                                5. Tr·∫£ l·ªùi c·ª±c k·ª≥ ng·∫Øn g·ªçn. C√¢u h·ªèi: ${text}`
                            }]
                        }]
                    })
                });
        
        const data = await res.json();
        
        if(data.error) throw new Error(data.error.message);
        
        const reply = data.candidates[0].content.parts[0].text;
        chatText.textContent = reply;
        
        // ƒê·ªçc to & Hi·ªáu ·ª©ng
        window.app.speak(reply);
        if(window.app.animatePetClick) window.app.animatePetClick();
        setTimeout(() => bubble.classList.add('hidden'), 6000);

    } catch(e) {
        console.error("L·ªói:", e);
        chatText.textContent = "L·ªói: " + e.message;
        setTimeout(() => bubble.classList.add('hidden'), 6000);
    }
}, // D·∫•u ph·∫©y n√†y l√† b·∫Øt bu·ªôc v√¨ h√†m speak theo sau
        
        speak: (text) => {
    if (!window.speechSynthesis) return;
    
    // Ng·∫Øt l·ªùi c≈© n·∫øu ƒëang n√≥i
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'vi-VN'; // Ng√¥n ng·ªØ Ti·∫øng Vi·ªát
    
    // TH·ª¶ THU·∫¨T GI·ªåNG TR·∫∫ CON V√Ä T·ªêI ∆ØU T·∫¢I GI·ªåNG N√ìI
    utterance.pitch = 1.6; // TƒÉng ƒë·ªô cao √¢m thanh (Gi·ªçng tr·∫ª con)
    utterance.rate = 1.1;  // N√≥i nhanh h∆°n m·ªôt ch√∫t
    utterance.volume = 1;

    // Logic quan tr·ªçng: ƒê·ª£i Voices (Gi·ªçng n√≥i) t·∫£i xong
    const setVoice = () => {
        const voices = window.speechSynthesis.getVoices();
        // C·ªë g·∫Øng t√¨m gi·ªçng Ti·∫øng Vi·ªát
        const vnVoice = voices.find(v => v.lang.includes('vi'));
        
        if (vnVoice) {
            utterance.voice = vnVoice;
        } else {
            // N·∫øu kh√¥ng t√¨m th·∫•y Ti·∫øng Vi·ªát, d√πng gi·ªçng m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
            console.warn("Kh√¥ng t√¨m th·∫•y gi·ªçng Ti·∫øng Vi·ªát. S·ª≠ d·ª•ng gi·ªçng m·∫∑c ƒë·ªãnh.");
        }
        
        // B·∫Øt ƒë·∫ßu n√≥i
        window.speechSynthesis.speak(utterance);
    };

    // Ki·ªÉm tra n·∫øu danh s√°ch gi·ªçng n√≥i ƒë√£ t·∫£i, th√¨ g·ªçi ngay
    if (window.speechSynthesis.getVoices().length) {
        setVoice();
    } else {
        // N·∫øu ch∆∞a t·∫£i, ch·ªù s·ª± ki·ªán onvoiceschanged (ch·ªâ ch·∫°y 1 l·∫ßn)
        window.speechSynthesis.onvoiceschanged = setVoice;
    }
}, // <-- ƒê·∫£m b·∫£o c√≥ d·∫•u ph·∫©y ·ªü cu·ªëi n·∫øu c√≥ h√†m kh√°c sau ƒë√≥

    }; // <--- ƒê√ÇY L√Ä D·∫§U K·∫æT TH√öC WINDOW.APP

    // Kh·ªüi ch·∫°y
    init();
    window.onload = init;
</script>





<footer class="text-center text-lg text-gray-500 py-4 mt-8 bg-white border-t">
    S·∫£n ph·∫©m CNTT c·ªßa c√¥ gi√°o ƒê·ªó Minh Thu <br> Tr∆∞·ªùng Ti·ªÉu h·ªçc H·ªìng Gai
</footer>
<div id="gratitude-screen" class="hidden fixed inset-0 z-50 bg-blue-100 flex flex-col justify-end items-center overflow-hidden transition-all duration-500">
    <button onclick="document.getElementById('gratitude-screen').classList.add('hidden')" class="absolute top-4 left-4 bg-white/80 p-2 rounded-full shadow-lg z-50 hover:bg-gray-100">
        <i data-lucide="arrow-left" class="text-gray-700"></i>
    </button>
    
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-40 bg-white/90 px-6 py-2 rounded-full shadow-lg border-2 border-green-500 w-max max-w-[90%] text-center">
        <h2 class="font-bold text-green-700 text-base md:text-xl uppercase">üå≥ C√¢y Bi·∫øt ∆†n L·ªõp 2A8</h2>
    </div>

    <div id="tree-wrapper" class="relative w-full max-w-2xl aspect-square flex-shrink-0">
        <img src="https://i.pinimg.com/originals/da/05/39/da053954ccc1da01b8c62126d971bfe1.gif" 
             class="w-full h-full object-contain drop-shadow-2xl pointer-events-none"
             alt="C√¢y bi·∫øt ∆°n">
        
        <div id="tree-fruits-container" class="absolute inset-0 w-full h-full"></div>
    </div>

    <button onclick="document.getElementById('gratitude-input-modal').classList.remove('hidden')" class="absolute bottom-8 right-4 z-50 bg-gradient-to-r from-green-500 to-green-700 text-white px-6 py-3 rounded-full shadow-lg font-bold animate-bounce hover:scale-105 transition">
        ‚úçÔ∏è Vi·∫øt ƒëi·ªÅu bi·∫øt ∆°n
    </button>
</div>

    <div id="tree-fruits-container" class="absolute inset-0 w-full h-full pointer-events-none">
        </div>
</div>
</div>

<div id="gratitude-input-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative animate-fade-in">
        <button onclick="document.getElementById('gratitude-input-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-red-500">
            <i data-lucide="x-circle" class="w-8 h-8"></i>
        </button>
        <h3 class="text-xl font-bold text-center text-green-600 mb-4">Gieo h·∫°t m·∫ßm bi·∫øt ∆°n üå±</h3>
        <textarea id="gratitude-content" rows="4" class="w-full border-2 border-green-100 rounded-xl p-3 focus:outline-none focus:border-green-500" placeholder="Con mu·ªën c·∫£m ∆°n... v√¨..."></textarea>
        <button onclick="window.app.postGratitude()" class="w-full mt-4 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition shadow-lg">
            Treo l√™n c√¢y üçé
        </button>
    </div>
</div>

<div id="gratitude-view-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onclick="this.classList.add('hidden')">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center border-4 border-red-400 relative animate-zoom-in" onclick="event.stopPropagation()">
        
        <button id="btn-delete-fruit" class="hidden absolute top-2 right-2 text-red-500 hover:bg-red-100 p-2 rounded-full" title="X√≥a qu·∫£ n√†y (Admin)">
            <i data-lucide="trash-2" width="20"></i>
        </button>

        <div class="text-6xl mb-4">üçé</div>
        <div id="gratitude-view-content" class="text-xl font-medium text-gray-800 mb-4 italic break-words whitespace-pre-wrap">...</div>
        <div id="gratitude-view-author" class="text-sm text-gray-500 font-bold uppercase tracking-widest">...</div>
        <div class="mt-6 text-xs text-gray-400">Ch·∫°m ra ngo√†i ƒë·ªÉ ƒë√≥ng</div>
    </div>
</div>
<div id="birthday-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm" onclick="this.classList.add('hidden')">
    <div class="bg-white p-8 rounded-3xl shadow-2xl text-center border-4 border-yellow-400 relative animate-bounce max-w-sm mx-4">
        <div class="text-6xl mb-4">üéÇüéâ</div>
        <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-yellow-500 to-blue-600 mb-2 uppercase">
            CH√öC M·ª™NG SINH NH·∫¨T!
        </h2>
        <p class="text-gray-600 text-sm mb-2">H√¥m nay l√† sinh nh·∫≠t c·ªßa:</p>
        <p id="bday-names" class="text-2xl font-extrabold text-indigo-700 mb-6"></p>
        <div class="text-xs text-gray-400">(Ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ ƒë√≥ng)</div>
    </div>
</div>
</body>

</html>











